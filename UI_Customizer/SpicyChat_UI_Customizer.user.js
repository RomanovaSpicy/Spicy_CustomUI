// ==UserScript==
// @name         SpicyChat UI Customizer
// @namespace    http://tampermonkey.net/
// @version      2.31
// @description  Customize SpicyChat UI. Requires 'SpicyChat Logic Core'.
// @author       Discord: @encode_your, SpicyChat: @sophieaaa (All), Sophie & Isid (Token Counter)
// @match        https://spicychat.ai/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=spicychat.ai
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_addStyle
// @grant        GM_info
// @updateURL    https://github.com/RomanovaSpicy/Spicy_CustomUI/raw/refs/heads/main/UI_Customizer/SpicyChat_UI_Customizer.user.js
// @downloadURL  https://github.com/RomanovaSpicy/Spicy_CustomUI/raw/refs/heads/main/UI_Customizer/SpicyChat_UI_Customizer.user.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const LOGO_ID = 'sc-persistent-logo';
    const POPUP_ID = 'sc-ui-customizer-popup';
    const DYNAMIC_STYLE_ID = 'sc-dynamic-customizer-style';
    const THEME_STYLE_ID = 'sc-current-theme-style';
    const BACKGROUND_STYLE_ID = 'sc-custom-background-style';
    const VIEW_SETTINGS_ID = 'sc-view-settings';
    const VIEW_THEMES_ID = 'sc-view-themes';
    const GUI_STYLES_ID = 'sc-customizer-gui-styles';
    const WIDTH_STYLE_ID = 'sc-dynamic-width-style';

    const FONT_SLIDER_ID = 'sc-fontsize-slider';
    const FONT_VALUE_ID = 'sc-fontsize-value';
    const WIDTH_SLIDER_ID = 'sc-width-slider';
    const WIDTH_VALUE_ID = 'sc-width-value';
    const OPACITY_SLIDER_ID = 'sc-opacity-slider';
    const OPACITY_VALUE_ID = 'sc-opacity-value';
    const AVATAR_SIZE_SLIDER_ID = 'sc-avatarsize-slider';
    const AVATAR_SIZE_VALUE_ID = 'sc-avatarsize-value';
    const BUTTON_ORDER_SELECT_ID = 'sc-button-order-select';
    const THEME_DISPLAY_ID = 'sc-current-theme-name';
    const CHANGE_THEME_BTN_ID = 'sc-change-theme-btn';
    const RESET_BTN_ID = 'sc-reset-settings-btn';
    const THEME_LIST_ID = 'sc-theme-list-container';
    const BACK_BTN_ID = 'sc-back-to-settings-btn';
    const BACKGROUND_URL_INPUT_ID = 'sc-background-url-input';
    const APPLY_BG_BTN_ID = 'sc-apply-bg-btn';
    const RESET_BG_BTN_ID = 'sc-reset-bg-btn';

    const STORAGE_THEME_KEY = 'scUICustomizer_Theme_v1';
    const STORAGE_FONT_SIZE_KEY = 'scUICustomizer_FontSize_v1';
    const STORAGE_WIDTH_KEY = 'scUICustomizer_Width_v1';
    const STORAGE_BACKGROUND_URL_KEY = 'scUICustomizer_BackgroundURL_v1';
    const STORAGE_OPACITY_KEY = 'scUICustomizer_Opacity_v1';
    const STORAGE_AVATAR_SIZE_KEY = 'scUICustomizer_AvatarSize_v1';
    const STORAGE_BUTTON_ORDER_KEY = 'scUICustomizer_ButtonOrder_v1';

    const SHARED_CHAT_CONTAINER_SELECTOR = 'div.grow.flex.flex-col.w-full.left-0.items-center.absolute.h-full.overflow-auto';
    const BACKGROUND_TARGET_SELECTOR = SHARED_CHAT_CONTAINER_SELECTOR;
    const CHAT_MESSAGES_CONTAINER_SELECTOR = SHARED_CHAT_CONTAINER_SELECTOR;

    const DEFAULT_FONT_SIZE = 14;
    const DEFAULT_THEME_KEY = 'coastal_mist';
    const DEFAULT_BACKGROUND_URL = null;
    const DEFAULT_OPACITY = 1.0;
    const MIN_WIDTH_SLIDER = 40;
    const MAX_WIDTH_SLIDER = 100;
    const DEFAULT_WIDTH_SLIDER = 50;
    const MIN_AVATAR_SIZE = 45;
    const MAX_AVATAR_SIZE = 150;
    const DEFAULT_AVATAR_SIZE = 45;
    const DEFAULT_BUTTON_ORDER = 'default';

    const messageContainerSelector_SLIDER = ".py-lg > .gap-md[style*='max-width:']";
    const AVATAR_BUTTON_SELECTOR_USER = '[data-ui-component="UserMessageAvatarButton"]';
    const AVATAR_BUTTON_SELECTOR_BOT = '[data-ui-component="BotMessageAvatarButton"]';
    const ALL_AVATAR_BUTTON_SELECTORS = `${AVATAR_BUTTON_SELECTOR_USER}, ${AVATAR_BUTTON_SELECTOR_BOT}`;
    const MESSAGE_ACTIONS_CONTAINER_SELECTOR = 'div[data-ui-component="BotMessageActionsContainer"]';
    const BUTTON_SELECTOR_STAR = 'button[data-ui-component="BotMessageRateButton"]';
    const BUTTON_SELECTOR_TTS = 'button[data-ui-component="BotMessageReadAloudButton"]';
    const BUTTON_SELECTOR_REGENERATE = 'button[data-ui-component="BotMessageRegenerateButton"]';
    const BUTTON_SELECTOR_EDIT = 'button[data-ui-component="BotMessageAddVariantButton"]';

    const JUMPER_ENABLE_CHECKBOX_ID = 'sc-jumper-enable-checkbox';
    const STORAGE_JUMPER_ENABLED_KEY = 'scUICustomizer_JumperEnabled_v1';
    const STORAGE_JUMPER_UI_POS_KEY = 'scUICustomizer_JumperUIPos_v1';
    const DEFAULT_JUMPER_ENABLED = false;
    const JUMPER_OUTER_MESSAGE_CONTAINER_SELECTOR = '[data-ui-component="BotMessageContainer"]';
    const JUMPER_NEXT_BUTTON_SELECTOR = '[data-ui-component="BotMessageNextVariantButton"]';
    const JUMPER_PREV_BUTTON_SELECTOR = '[data-ui-component="BotMessagePreviousVariantButton"]';
    const JUMPER_CURRENT_VARIANT_TEXT_SELECTOR = '[data-ui-component="BotMessageVariantInfoText"]';
    const JUMPER_UI_CONTAINER_ID = 'llmJumperContainer';
    const JUMPER_UI_HEADER_ID = 'llmJumperHeader';
    const JUMPER_INPUT_ID = 'llmVariantInput';
    const JUMPER_BUTTON_ID = 'llmVariantJumpBtn';
    let isJumperEnabled = DEFAULT_JUMPER_ENABLED;
    let jumperUiContainer = null;
    let jumperIsDragging = false;
    let jumperOffsetX, jumperOffsetY;

    const TOKEN_COUNTER_ENABLE_CHECKBOX_ID = 'sc-token-counter-enable-checkbox';
    const STORAGE_TOKEN_COUNTER_ENABLED_KEY = 'scUICustomizer_TokenCounterEnabled_v1';
    const DEFAULT_TOKEN_COUNTER_ENABLED = false;
    const TOKEN_COUNTER_STYLE_ID = 'sc-token-counter-style';
    const TOKEN_COUNTER_USER_MESSAGE_SELECTOR = '.text-colorQuote';
    const TOKEN_COUNTER_BOT_MESSAGE_SELECTOR = '.flex.flex-col.w-full.break-words';
    const TOKEN_COUNTER_PROCESSED_MARKER = 'data-token-counted-v34sc';
    const TOKEN_COUNTER_DATA_ATTRIBUTE_NAME = 'data-token-count-sc';
    let isTokenCounterEnabled = DEFAULT_TOKEN_COUNTER_ENABLED;
    let tokenCounter_countTokensFunc = null;
    let tokenCounter_observer = null;
    let tokenCounter_styleElement = null;
    let tokenCounter_tokenizerModuleLoaded = false;
    let tokenCounter_initializationTimer = null;

    const themes = {
        'coastal_mist': {
            name: 'üå´Ô∏è Coastal Mist',
            description: 'Refined dark theme. Clear text hierarchy, comfortable blues/greys, professional feel.',
            css: `:root { --cm-bg-0: #1A1D23; --cm-bg-1: #21252E; --cm-bg-2: #2A303C; --cm-bg-3: #384050; --cm-text-main: #E0E5F0; --cm-text-italic: #C3A6D5; --cm-text-quote: #88C0D0; --cm-text-sender: #9EB0C7; --cm-accent: #81A1C1; --cm-accent-hover: #8FBCBB; --cm-border: #3E485A; --cm-border-focus: #5E81AC; --cm-shadow-heavy: rgba(0, 0, 0, 0.4); --cm-shadow-medium: rgba(0, 0, 0, 0.25); --cm-shadow-light: rgba(0, 0, 0, 0.15); --cm-user-message-bg: var(--cm-bg-1); --cm-bot-message-bg: var(--cm-bg-2); } html.dark body { background: linear-gradient(170deg, var(--cm-bg-0) 0%, var(--cm-bg-1) 100%) !important; background-attachment: fixed !important; font-family: 'Inter', sans-serif; } html.dark body::before { display: none !important; } [data-ui-component="SideNavBar"], ${SHARED_CHAT_CONTAINER_SELECTOR} { background-color: transparent !important; scrollbar-width: thin !important; scrollbar-color: var(--cm-bg-3) transparent !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar { width: 9px !important; height: 9px !important; background-color: transparent !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar-track, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar-track { background: rgba(33, 37, 46, 0.4) !important; border-radius: 5px !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar-thumb, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar-thumb { background-color: var(--cm-bg-3) !important; border-radius: 5px !important; border: 1px solid var(--cm-bg-1) !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar-thumb:hover, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar-thumb:hover { background-color: var(--cm-accent) !important; } [data-ui-component="ChatHeaderBar"] { background: var(--cm-bg-1) !important; border-bottom: 1px solid var(--cm-border) !important; box-shadow: 0 3px 8px var(--cm-shadow-medium); padding: 6px 0 !important; } [data-ui-component="SideNavBar"] { background: var(--cm-bg-1) !important; border-right: 1px solid var(--cm-border) !important; box-shadow: 2px 0 7px var(--cm-shadow-medium); } [data-ui-component="ChatHeaderCharacterName"], [data-ui-component="ChatHeaderCreatorName"] { color: #C0CADB !important; font-weight: 500; } [data-ui-component="ChatHeaderShareButton"] svg, [data-ui-component="ChatHeaderMoreOptionsButton"] svg, [data-ui-component="ChatHeaderLikeButton"] svg { stroke: var(--cm-text-sender) !important; transition: stroke 0.2s ease; } [data-ui-component="ChatHeaderShareButton"]:hover svg, [data-ui-component="ChatHeaderMoreOptionsButton"]:hover svg, [data-ui-component="ChatHeaderLikeButton"]:hover svg { stroke: var(--cm-accent-hover) !important; } [data-ui-component^="SideNav"] button { color: var(--cm-text-sender) !important; transition: background-color 0.2s ease, color 0.2s ease, border-left-color 0.2s ease; border-radius: 0 5px 5px 0 !important; padding: 8px 12px 8px 15px; border-left: 3px solid transparent; } [data-ui-component^="SideNav"] button:hover { background-color: var(--cm-accent) !important; color: var(--cm-bg-0) !important; border-left-color: var(--cm-accent-hover) !important; } [data-ui-component^="SideNav"] button svg { stroke: var(--cm-text-sender) !important; transition: stroke 0.2s ease; } [data-ui-component^="SideNav"] button:hover svg { stroke: var(--cm-bg-0) !important; } [data-ui-component="BotMessageContainer"], [data-ui-component="ChatHeroInnerContainer"] { background-color: color-mix(in srgb, transparent, var(--cm-bot-message-bg) calc(var(--message-bg-opacity) * 100%)) !important; } [data-ui-component="UserMessageBackgroundContainer"], [data-ui-component="ChatMessageWrapper"].bg-gray-4 { background-color: color-mix(in srgb, transparent, var(--cm-user-message-bg) calc(var(--message-bg-opacity) * 100%)) !important; } [data-ui-component="BotMessageContainer"], [data-ui-component="UserMessageBackgroundContainer"], [data-ui-component="ChatHeroInnerContainer"] { border: 1px solid var(--cm-border) !important; border-radius: 8px !important; padding: 1rem 1.3rem !important; margin-bottom: 1.1rem !important; box-shadow: 0 3px 8px var(--cm-shadow-light); transition: box-shadow 0.25s ease, border-color 0.25s ease, transform 0.1s ease, width 0.1s ease-out, background-color 0.2s ease; } [data-ui-component="BotMessageContainer"]:hover, [data-ui-component="UserMessageBackgroundContainer"]:hover { border-color: var(--cm-border-focus) !important; box-shadow: 0 5px 12px var(--cm-shadow-medium); transform: translateY(-1px); } [data-ui-component="BotMessageContainer"] { border-left: 3px solid var(--cm-accent) !important; } [data-ui-component="UserMessageBackgroundContainer"] { border-left: 3px solid var(--cm-bg-3) !important; } [data-ui-component="ChatHeroInnerContainer"] { background: linear-gradient(145deg, var(--cm-bg-2), var(--cm-bg-1)); border-color: var(--cm-border) !important; box-shadow: 0 4px 10px var(--cm-shadow-medium); } [data-ui-component="MessageSenderName"] { color: var(--cm-text-sender) !important; font-weight: 600; margin-bottom: 5px; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;} [data-ui-component="MessageTextSpan"] { color: var(--cm-text-main) !important; line-height: inherit !important; } [data-ui-component="MessageTextSpan"] > em { color: var(--cm-text-italic) !important; font-style: italic !important; font-weight: 500; } [data-ui-component="MessageTextSpan"] > q { color: var(--cm-text-quote) !important; font-style: italic !important; opacity: 1; background-color: rgba(136, 192, 208, 0.08); border-left: 3px solid rgba(136, 192, 208, 0.5); padding: 0.1em 0.6em; display: inline-block; margin: 0.15em 0; border-radius: 0 4px 4px 0; } [data-ui-component="MessageActionsContainer"] button svg { stroke: var(--cm-text-sender) !important; transition: stroke 0.2s ease; } [data-ui-component="MessageActionsContainer"] button:hover svg { stroke: var(--cm-accent-hover) !important; } [data-ui-component="BotMessageRateButton"][aria-label*='Star-button'].opacity-100 svg { fill: #EBCB8B !important; stroke: #EBCB8B !important; } [data-ui-component="ChatInputBarContainer"] { background-color: transparent !important; border-top: none !important; padding: 5px 10px 15px 10px !important; } [data-ui-component="ChatInputBarInnerContainer"] { padding: 0 !important; } [data-ui-component="TextInputAreaWrapper"] { background-color: var(--cm-bg-1) !important; border: 1px solid var(--cm-border) !important; border-radius: 8px !important; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); margin: 0 !important; padding: 4px 10px !important; transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease; display: flex !important; align-items: center; } [data-ui-component="TextInputAreaWrapper"]:focus-within { border-color: var(--cm-border-focus) !important; background-color: var(--cm-bg-2) !important; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2), 0 0 0 3px rgba(94, 129, 172, 0.2); } [data-ui-component="MessageInputTextarea"] { color: var(--cm-text-main) !important; caret-color: var(--cm-accent); background: transparent !important; padding: 11px 8px !important; flex-grow: 1; font-size: inherit; line-height: 1.6 !important; } [data-ui-component="MessageInputTextarea"]::placeholder { color: var(--cm-text-sender) !important; opacity: 0.6; font-style: italic; } [data-ui-component="SendButtonContainer"] { background-color: var(--cm-accent) !important; border-radius: 7px !important; margin-left: 10px !important; padding: 9px !important; transition: background-color 0.2s ease, transform 0.1s ease; box-shadow: 0 2px 4px var(--cm-shadow-medium); display: flex; align-items: center; justify-content: center; border: none; } [data-ui-component="SendButtonContainer"]:hover { background-color: var(--cm-accent-hover) !important; transform: scale(1.05); } [data-ui-component="SendButtonIcon"] { stroke: var(--cm-bg-0) !important; width: 22px; height: 22px; }`
        },
        'librarium_dusk_dark': {
            name: 'üìö Librarium Dusk (Dark)',
            description: 'Dark & cozy library feel. Creamy text on deep browns, warm amber/gold accents, serif font.',
            css: `:root { --ldd-bg-0: #261F1A; --ldd-bg-1: #3A2D25; --ldd-bg-2: #4A3C31; --ldd-bg-3: #5C4E44; --ldd-text-main: #EAE0D5; --ldd-text-italic: #E8B878; --ldd-text-quote: #A0B8A8; --ldd-text-sender: #A89888; --ldd-accent: #C5A06A; --ldd-accent-hover: #D8B884; --ldd-border: #5C4E44; --ldd-border-focus: #C5A06A; --ldd-shadow-heavy: rgba(0, 0, 0, 0.5); --ldd-shadow-medium: rgba(0, 0, 0, 0.3); --ldd-shadow-light: rgba(0, 0, 0, 0.2); --ldd-texture: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQwIDc5LjE2MDQ1MSwgMjAxNy8wNS8wNi0wMTowODoyMSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTggKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjE1ODgzNEFGMjkyMTExRUE5OEI3RDI2NzQ2Rjg3QUU3IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjE1ODgzNEIwMjkyMTExRUE5OEI3RDI2NzQ2Rjg3QUU3Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6MTU4ODM0QUQyOTIxMTFFQTk4QjdEMjY3NDZGODdBRTciIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6MTU4ODM0QUUyOTIxMTFFQTk4QjdEMjY3NDZGODdBRTciLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6aNps0AAAAWUlEQVR42uzMMQEAAAgDINcP9qUQ+6cBQa4caCp48uTJkydPnjx58uTJkydPnjx58uTJkydPnjx58uTJkydPnjx58uTJkydPnjx58uTJkydPnjx58uTJkyc/LoAAMAQ9r6gAUUB40AAAAASUVORK5CYII='); --ldd-user-message-bg: var(--ldd-bg-1); --ldd-bot-message-bg: var(--ldd-bg-2); } html.dark body { background: var(--ldd-bg-0) !important; background-image: var(--ldd-texture), linear-gradient(170deg, var(--ldd-bg-0) 0%, #1c1612 100%) !important; background-blend-mode: overlay; background-attachment: fixed !important; font-family: 'Merriweather', serif; color: var(--ldd-text-main); } html.dark body::before { display: none !important; } [data-ui-component="SideNavBar"], ${SHARED_CHAT_CONTAINER_SELECTOR} { background-color: transparent !important; scrollbar-width: thin !important; scrollbar-color: var(--ldd-bg-3) transparent !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar { width: 10px !important; height: 10px !important; background-color: transparent !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar-track, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar-track { background: rgba(58, 45, 37, 0.4) !important; border-radius: 5px !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar-thumb, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar-thumb { background-color: var(--ldd-bg-3) !important; border-radius: 5px !important; border: 1px solid var(--ldd-bg-1) !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar-thumb:hover, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar-thumb:hover { background-color: var(--ldd-accent) !important; } [data-ui-component="ChatHeaderBar"] { background: var(--ldd-bg-1) !important; background-image: var(--ldd-texture) !important; background-blend-mode: overlay; border-bottom: 1px solid var(--ldd-border) !important; box-shadow: 0 2px 7px var(--ldd-shadow-medium); padding: 6px 0 !important; } [data-ui-component="SideNavBar"] { background: var(--ldd-bg-1) !important; background-image: var(--ldd-texture) !important; background-blend-mode: overlay; border-right: 1px solid var(--ldd-border) !important; box-shadow: 2px 0 6px var(--ldd-shadow-medium); } [data-ui-component="ChatHeaderCharacterName"], [data-ui-component="ChatHeaderCreatorName"] { color: #D4C8BC !important; font-weight: 500; font-family: 'Inter', sans-serif; } [data-ui-component="ChatHeaderShareButton"] svg, [data-ui-component="ChatHeaderMoreOptionsButton"] svg, [data-ui-component="ChatHeaderLikeButton"] svg { stroke: var(--ldd-text-sender) !important; transition: stroke 0.2s ease; } [data-ui-component="ChatHeaderShareButton"]:hover svg, [data-ui-component="ChatHeaderMoreOptionsButton"]:hover svg, [data-ui-component="ChatHeaderLikeButton"]:hover svg { stroke: var(--ldd-accent-hover) !important; } [data-ui-component^="SideNav"] button { color: var(--ldd-text-sender) !important; transition: background-color 0.2s ease, color 0.2s ease; border-radius: 5px !important; font-family: 'Inter', sans-serif; padding: 8px 12px; } [data-ui-component^="SideNav"] button:hover { background-color: var(--ldd-accent) !important; color: var(--ldd-bg-0) !important; } [data-ui-component^="SideNav"] button svg { stroke: var(--ldd-text-sender) !important; transition: stroke 0.2s ease; } [data-ui-component^="SideNav"] button:hover svg { stroke: var(--ldd-bg-0) !important; } [data-ui-component="BotMessageContainer"], [data-ui-component="ChatHeroInnerContainer"] { background-color: color-mix(in srgb, transparent, var(--ldd-bot-message-bg) calc(var(--message-bg-opacity) * 100%)) !important; } [data-ui-component="UserMessageBackgroundContainer"], [data-ui-component="ChatMessageWrapper"].bg-gray-4 { background-color: color-mix(in srgb, transparent, var(--ldd-user-message-bg) calc(var(--message-bg-opacity) * 100%)) !important; } [data-ui-component="BotMessageContainer"], [data-ui-component="UserMessageBackgroundContainer"], [data-ui-component="ChatHeroInnerContainer"] { border: 1px solid var(--ldd-border) !important; background-image: var(--ldd-texture) !important; background-blend-mode: overlay; border-radius: 6px !important; padding: 1rem 1.3rem !important; margin-bottom: 1.1rem !important; box-shadow: 0 3px 8px var(--ldd-shadow-light); transition: box-shadow 0.25s ease, border-color 0.25s ease, transform 0.1s ease, width 0.1s ease-out, background-color 0.2s ease; } [data-ui-component="BotMessageContainer"]:hover, [data-ui-component="UserMessageBackgroundContainer"]:hover { border-color: var(--ldd-border-focus) !important; box-shadow: 0 5px 12px var(--ldd-shadow-medium); transform: translateY(-1px); } [data-ui-component="BotMessageContainer"] { border-left: 3px solid var(--ldd-accent) !important; } [data-ui-component="UserMessageBackgroundContainer"] { border-left: 3px solid var(--ldd-bg-3) !important; } [data-ui-component="ChatHeroInnerContainer"] { background: linear-gradient(145deg, var(--ldd-bg-2), var(--ldd-bg-1)); border-color: var(--ldd-border) !important; box-shadow: 0 4px 10px var(--ldd-shadow-medium); } [data-ui-component="MessageSenderName"] { color: var(--ldd-text-sender) !important; font-weight: 600; font-family: 'Inter', sans-serif; margin-bottom: 5px; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; } [data-ui-component="MessageTextSpan"] { color: var(--ldd-text-main) !important; line-height: inherit !important; } [data-ui-component="MessageTextSpan"] > em { color: var(--ldd-text-italic) !important; font-style: italic !important; font-weight: 500; } [data-ui-component="MessageTextSpan"] > q { color: var(--ldd-text-quote) !important; font-style: italic !important; opacity: 1; background-color: rgba(160, 184, 168, 0.1); border-left: 3px solid rgba(160, 184, 168, 0.5); padding: 0.1em 0.6em; display: inline-block; margin: 0.15em 0; border-radius: 0 4px 4px 0; } [data-ui-component="MessageActionsContainer"] button svg { stroke: var(--ldd-text-sender) !important; transition: stroke 0.2s ease; } [data-ui-component="MessageActionsContainer"] button:hover svg { stroke: var(--ldd-accent-hover) !important; } [data-ui-component="BotMessageRateButton"][aria-label*='Star-button'].opacity-100 svg { fill: #E8B878 !important; stroke: #D4A06A !important; } [data-ui-component="ChatInputBarContainer"] { background-color: transparent !important; border-top: none !important; padding: 5px 10px 15px 10px !important; } [data-ui-component="ChatInputBarInnerContainer"] { padding: 0 !important; } [data-ui-component="TextInputAreaWrapper"] { background-color: var(--ldd-bg-1) !important; background-image: var(--ldd-texture) !important; background-blend-mode: overlay; border: 1px solid var(--ldd-border) !important; border-radius: 6px !important; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); margin: 0 !important; padding: 4px 10px !important; transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease; display: flex !important; align-items: center; } [data-ui-component="TextInputAreaWrapper"]:focus-within { border-color: var(--ldd-border-focus) !important; background-color: var(--ldd-bg-2) !important; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3), 0 0 0 3px rgba(197, 160, 106, 0.25); } [data-ui-component="MessageInputTextarea"] { color: var(--ldd-text-main) !important; caret-color: var(--ldd-accent); background: transparent !important; padding: 11px 8px !important; flex-grow: 1; font-size: inherit; line-height: 1.6 !important; font-family: 'Merriweather', serif; } [data-ui-component="MessageInputTextarea"]::placeholder { color: var(--ldd-text-sender) !important; opacity: 0.6; font-style: italic; } [data-ui-component="SendButtonContainer"] { background-color: var(--ldd-accent) !important; border-radius: 5px !important; margin-left: 10px !important; padding: 9px !important; transition: background-color 0.2s ease, transform 0.1s ease; box-shadow: 0 2px 4px var(--ldd-shadow-medium); display: flex; align-items: center; justify-content: center; border: none; } [data-ui-component="SendButtonContainer"]:hover { background-color: var(--ldd-accent-hover) !important; transform: scale(1.05); } [data-ui-component="SendButtonIcon"] { stroke: var(--ldd-bg-0) !important; width: 22px; height: 22px; }`
        },
        'sakura_dreams_night': {
            name: 'üåô Sakura Dreams (Night)',
            description: 'Moonlit pastels. Soft lavender text on deep indigo, pink/mint accents.',
            css: `:root { --sdn-bg-0: #1E1C2B; --sdn-bg-1: #2A283A; --sdn-bg-2: #353248; --sdn-bg-3: #45415A; --sdn-text-main: #EAE6F5; --sdn-text-italic: #F8A0C4; --sdn-text-quote: #A0D8C0; --sdn-text-sender: #A8A0B8; --sdn-accent-pink: #E888AE; --sdn-accent-pink-hover: #F0A0C0; --sdn-accent-green: #8FBC8F; --sdn-border: #45415A; --sdn-border-focus: #E888AE; --sdn-shadow-heavy: rgba(0, 0, 0, 0.5); --sdn-shadow-medium: rgba(0, 0, 0, 0.3); --sdn-shadow-light: rgba(0, 0, 0, 0.2); --sdn-texture: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path d="M50 0 C 50 0, 0 50, 50 100 C 100 50, 50 0, 50 0 Z" fill="%23${'EAE6F5'.substring(1)}" opacity="0.02" transform="rotate(45 50 50) scale(1.5)" /></svg>'); --sdn-user-message-bg: var(--sdn-bg-1); --sdn-bot-message-bg: var(--sdn-bg-2); } html.dark body { background: var(--sdn-bg-0) !important; background-image: var(--sdn-texture), linear-gradient(170deg, var(--sdn-bg-0) 0%, #151320 100%) !important; background-blend-mode: overlay; background-attachment: fixed !important; font-family: 'Inter', sans-serif; color: var(--sdn-text-main); } html.dark body::before { display: none !important; } [data-ui-component="SideNavBar"], ${SHARED_CHAT_CONTAINER_SELECTOR} { background-color: transparent !important; scrollbar-width: thin !important; scrollbar-color: var(--sdn-bg-3) transparent !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar { width: 9px !important; height: 9px !important; background-color: transparent !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar-track, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar-track { background: rgba(42, 40, 58, 0.4) !important; border-radius: 5px !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar-thumb, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar-thumb { background-color: var(--sdn-bg-3) !important; border-radius: 5px !important; border: 1px solid var(--sdn-bg-1) !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar-thumb:hover, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar-thumb:hover { background-color: var(--sdn-accent-pink) !important; } [data-ui-component="ChatHeaderBar"] { background: var(--sdn-bg-1) !important; border-bottom: 1px solid var(--sdn-border) !important; box-shadow: 0 2px 7px var(--sdn-shadow-medium); padding: 6px 0 !important; } [data-ui-component="SideNavBar"] { background: var(--sdn-bg-1) !important; border-right: 1px solid var(--sdn-border) !important; box-shadow: 1px 0 6px var(--sdn-shadow-medium); } [data-ui-component="ChatHeaderCharacterName"], [data-ui-component="ChatHeaderCreatorName"] { color: #D0C8E0 !important; font-weight: 500; } [data-ui-component="ChatHeaderShareButton"] svg, [data-ui-component="ChatHeaderMoreOptionsButton"] svg, [data-ui-component="ChatHeaderLikeButton"] svg { stroke: var(--sdn-text-sender) !important; transition: stroke 0.2s ease; } [data-ui-component="ChatHeaderShareButton"]:hover svg, [data-ui-component="ChatHeaderMoreOptionsButton"]:hover svg, [data-ui-component="ChatHeaderLikeButton"]:hover svg { stroke: var(--sdn-accent-pink-hover) !important; } [data-ui-component^="SideNav"] button { color: var(--sdn-text-sender) !important; transition: background-color 0.2s ease, color 0.2s ease, border-left-color 0.2s ease; border-radius: 0 6px 6px 0 !important; padding: 8px 12px 8px 15px; border-left: 3px solid transparent; } [data-ui-component^="SideNav"] button:hover { background-color: var(--sdn-accent-pink) !important; color: #FFFFFF !important; border-left-color: var(--sdn-accent-pink-hover) !important; } [data-ui-component^="SideNav"] button svg { stroke: var(--sdn-text-sender) !important; transition: stroke 0.2s ease; } [data-ui-component^="SideNav"] button:hover svg { stroke: #FFFFFF !important; } [data-ui-component="BotMessageContainer"], [data-ui-component="ChatHeroInnerContainer"] { background-color: color-mix(in srgb, transparent, var(--sdn-bot-message-bg) calc(var(--message-bg-opacity) * 100%)) !important; } [data-ui-component="UserMessageBackgroundContainer"], [data-ui-component="ChatMessageWrapper"].bg-gray-4 { background-color: color-mix(in srgb, transparent, var(--sdn-user-message-bg) calc(var(--message-bg-opacity) * 100%)) !important; } [data-ui-component="BotMessageContainer"], [data-ui-component="UserMessageBackgroundContainer"], [data-ui-component="ChatHeroInnerContainer"] { border: 1px solid var(--sdn-border) !important; border-radius: 10px !important; padding: 1rem 1.3rem !important; margin-bottom: 1rem !important; box-shadow: 0 3px 8px var(--sdn-shadow-light); transition: box-shadow 0.25s ease, border-color 0.25s ease, transform 0.1s ease, width 0.1s ease-out, background-color 0.2s ease; } [data-ui-component="BotMessageContainer"]:hover, [data-ui-component="UserMessageBackgroundContainer"]:hover { border-color: var(--sdn-border-focus) !important; box-shadow: 0 5px 12px var(--sdn-shadow-medium); transform: translateY(-1px); } [data-ui-component="BotMessageContainer"] { border-left: 3px solid var(--sdn-accent-pink) !important; } [data-ui-component="UserMessageBackgroundContainer"] { border-left: 3px solid var(--sdn-accent-green) !important; } [data-ui-component="ChatHeroInnerContainer"] { background: linear-gradient(145deg, var(--sdn-bg-2), var(--sdn-bg-1)); border-color: var(--sdn-border) !important; box-shadow: 0 4px 10px var(--sdn-shadow-medium); } [data-ui-component="MessageSenderName"] { color: var(--sdn-text-sender) !important; font-weight: 600; margin-bottom: 5px; font-size: 0.9em; } [data-ui-component="MessageTextSpan"] { color: var(--sdn-text-main) !important; line-height: inherit !important; } [data-ui-component="MessageTextSpan"] > em { color: var(--sdn-text-italic) !important; font-style: italic !important; font-weight: 500; } [data-ui-component="MessageTextSpan"] > q { color: var(--sdn-text-quote) !important; font-style: italic !important; opacity: 1; background-color: rgba(160, 216, 192, 0.1); border-left: 3px solid rgba(160, 216, 192, 0.5); padding: 0.1em 0.6em; display: inline-block; margin: 0.15em 0; border-radius: 0 4px 4px 0; } [data-ui-component="MessageActionsContainer"] button svg { stroke: var(--sdn-text-sender) !important; transition: stroke 0.2s ease; } [data-ui-component="MessageActionsContainer"] button:hover svg { stroke: var(--sdn-accent-pink-hover) !important; } [data-ui-component="BotMessageRateButton"][aria-label*='Star-button'].opacity-100 svg { fill: #FFD700 !important; stroke: #DAA520 !important; } [data-ui-component="ChatInputBarContainer"] { background-color: transparent !important; border-top: none !important; padding: 5px 10px 15px 10px !important; } [data-ui-component="ChatInputBarInnerContainer"] { padding: 0 !important; } [data-ui-component="TextInputAreaWrapper"] { background-color: var(--sdn-bg-1) !important; border: 1px solid var(--sdn-border) !important; border-radius: 10px !important; box-shadow: inset 0 2px 4px rgba(0,0,0,0.25); margin: 0 !important; padding: 4px 10px !important; transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease; display: flex !important; align-items: center; } [data-ui-component="TextInputAreaWrapper"]:focus-within { border-color: var(--sdn-border-focus) !important; background-color: var(--sdn-bg-2) !important; box-shadow: inset 0 2px 4px rgba(0,0,0,0.25), 0 0 0 3px rgba(232, 136, 174, 0.2); } [data-ui-component="MessageInputTextarea"] { color: var(--sdn-text-main) !important; caret-color: var(--sdn-accent-pink); background: transparent !important; padding: 11px 8px !important; flex-grow: 1; font-size: inherit; line-height: 1.6 !important; } [data-ui-component="MessageInputTextarea"]::placeholder { color: var(--sdn-text-sender) !important; opacity: 0.6; font-style: italic; } [data-ui-component="SendButtonContainer"] { background-color: var(--sdn-accent-pink) !important; border-radius: 8px !important; margin-left: 10px !important; padding: 9px !important; transition: background-color 0.2s ease, transform 0.1s ease; box-shadow: 0 2px 4px var(--sdn-shadow-medium); display: flex; align-items: center; justify-content: center; border: none; } [data-ui-component="SendButtonContainer"]:hover { background-color: var(--sdn-accent-pink-hover) !important; transform: scale(1.05); } [data-ui-component="SendButtonIcon"] { stroke: #FFFFFF !important; width: 22px; height: 22px; }`
        },
        'golden_sands_twilight': {
            name: 'üèúÔ∏è Golden Sands (Twilight)',
            description: 'Warm desert night theme. Sandy text on dark bronze, rich gold/copper accents.',
            css: `:root { --gst-bg-0: #201C18; --gst-bg-1: #332A22; --gst-bg-2: #453A2F; --gst-bg-3: #5A4D3F; --gst-text-main: #F5EFE5; --gst-text-italic: #E89868; --gst-text-quote: #88B0A8; --gst-text-sender: #B0A08C; --gst-accent-gold: #D8B884; --gst-accent-gold-hover: #E8C898; --gst-accent-copper: #C88462; --gst-border: #5A4D3F; --gst-border-focus: #D8B884; --gst-shadow-heavy: rgba(0, 0, 0, 0.5); --gst-shadow-medium: rgba(0, 0, 0, 0.3); --gst-shadow-light: rgba(0, 0, 0, 0.2); --gst-texture: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAQKADAAQAAAABAAAAQAAAAABGUUKwAAAAYElEQVR4Ae3BMQEAAADCoPVPbQhfoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAPgZAADSDAABI5o46AAAAABJRU5ErkJggg=='); --gst-user-message-bg: var(--gst-bg-1); --gst-bot-message-bg: var(--gst-bg-2); } html.dark body { background: var(--gst-bg-0) !important; background-image: var(--gst-texture), linear-gradient(170deg, var(--gst-bg-0) 0%, #181411 100%) !important; background-blend-mode: overlay; background-attachment: fixed !important; font-family: 'Inter', sans-serif; color: var(--gst-text-main); } html.dark body::before { display: none !important; } [data-ui-component="SideNavBar"], ${SHARED_CHAT_CONTAINER_SELECTOR} { background-color: transparent !important; scrollbar-width: thin !important; scrollbar-color: var(--gst-bg-3) transparent !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar { width: 10px !important; height: 10px !important; background-color: transparent !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar-track, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar-track { background: rgba(51, 42, 34, 0.4) !important; border-radius: 5px !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar-thumb, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar-thumb { background-color: var(--gst-bg-3) !important; border-radius: 5px !important; border: 1px solid var(--gst-bg-1) !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar-thumb:hover, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar-thumb:hover { background-color: var(--gst-accent-gold) !important; } [data-ui-component="ChatHeaderBar"] { background: var(--gst-bg-1) !important; border-bottom: 1px solid var(--gst-border) !important; box-shadow: 0 2px 7px var(--gst-shadow-medium); padding: 6px 0 !important; } [data-ui-component="SideNavBar"] { background: var(--gst-bg-1) !important; border-right: 1px solid var(--gst-border) !important; box-shadow: 1px 0 6px var(--gst-shadow-medium); } [data-ui-component="ChatHeaderCharacterName"], [data-ui-component="ChatHeaderCreatorName"] { color: #D8C8B4 !important; font-weight: 500; } [data-ui-component="ChatHeaderShareButton"] svg, [data-ui-component="ChatHeaderMoreOptionsButton"] svg, [data-ui-component="ChatHeaderLikeButton"] svg { stroke: var(--gst-text-sender) !important; transition: stroke 0.2s ease; } [data-ui-component="ChatHeaderShareButton"]:hover svg, [data-ui-component="ChatHeaderMoreOptionsButton"]:hover svg, [data-ui-component="ChatHeaderLikeButton"]:hover svg { stroke: var(--gst-accent-gold-hover) !important; } [data-ui-component^="SideNav"] button { color: var(--gst-text-sender) !important; transition: background-color 0.2s ease, color 0.2s ease; border-radius: 6px !important; padding: 8px 12px; } [data-ui-component^="SideNav"] button:hover { background-color: var(--gst-accent-gold) !important; color: var(--gst-bg-0) !important; } [data-ui-component^="SideNav"] button svg { stroke: var(--gst-text-sender) !important; transition: stroke 0.2s ease; } [data-ui-component^="SideNav"] button:hover svg { stroke: var(--gst-bg-0) !important; } [data-ui-component="BotMessageContainer"], [data-ui-component="ChatHeroInnerContainer"] { background-color: color-mix(in srgb, transparent, var(--gst-bot-message-bg) calc(var(--message-bg-opacity) * 100%)) !important; } [data-ui-component="UserMessageBackgroundContainer"], [data-ui-component="ChatMessageWrapper"].bg-gray-4 { background-color: color-mix(in srgb, transparent, var(--gst-user-message-bg) calc(var(--message-bg-opacity) * 100%)) !important; } [data-ui-component="BotMessageContainer"], [data-ui-component="UserMessageBackgroundContainer"], [data-ui-component="ChatHeroInnerContainer"] { border: 1px solid var(--gst-border) !important; background-image: var(--gst-texture) !important; background-blend-mode: overlay; border-radius: 8px !important; padding: 1rem 1.3rem !important; margin-bottom: 1rem !important; box-shadow: 0 3px 8px var(--gst-shadow-light); transition: box-shadow 0.25s ease, border-color 0.25s ease, transform 0.1s ease, width 0.1s ease-out, background-color 0.2s ease; } [data-ui-component="BotMessageContainer"]:hover, [data-ui-component="UserMessageBackgroundContainer"]:hover { border-color: var(--gst-border-focus) !important; box-shadow: 0 5px 12px var(--gst-shadow-medium); transform: translateY(-1px); } [data-ui-component="BotMessageContainer"] { border-left: 3px solid var(--gst-accent-gold) !important; } [data-ui-component="UserMessageBackgroundContainer"] { border-left: 3px solid var(--gst-accent-copper) !important; } [data-ui-component="ChatHeroInnerContainer"] { background: linear-gradient(145deg, var(--gst-bg-2), var(--gst-bg-1)); border-color: var(--gst-border) !important; box-shadow: 0 4px 10px var(--gst-shadow-medium); } [data-ui-component="MessageSenderName"] { color: var(--gst-text-sender) !important; font-weight: 600; margin-bottom: 5px; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; } [data-ui-component="MessageTextSpan"] { color: var(--gst-text-main) !important; line-height: inherit !important; } [data-ui-component="MessageTextSpan"] > em { color: var(--gst-text-italic) !important; font-style: italic !important; font-weight: 500; } [data-ui-component="MessageTextSpan"] > q { color: var(--gst-text-quote) !important; font-style: italic !important; opacity: 1; background-color: rgba(136, 176, 168, 0.1); border-left: 3px solid rgba(136, 176, 168, 0.5); padding: 0.1em 0.6em; display: inline-block; margin: 0.15em 0; border-radius: 0 4px 4px 0; } [data-ui-component="MessageActionsContainer"] button svg { stroke: var(--gst-text-sender) !important; transition: stroke 0.2s ease; } [data-ui-component="MessageActionsContainer"] button:hover svg { stroke: var(--gst-accent-gold-hover) !important; } [data-ui-component="BotMessageRateButton"][aria-label*='Star-button'].opacity-100 svg { fill: var(--gst-accent-copper) !important; stroke: #A86442 !important; } [data-ui-component="ChatInputBarContainer"] { background-color: transparent !important; border-top: none !important; padding: 5px 10px 15px 10px !important; } [data-ui-component="ChatInputBarInnerContainer"] { padding: 0 !important; } [data-ui-component="TextInputAreaWrapper"] { background-color: var(--gst-bg-1) !important; background-image: var(--gst-texture) !important; background-blend-mode: overlay; border: 1px solid var(--gst-border) !important; border-radius: 8px !important; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); margin: 0 !important; padding: 4px 10px !important; transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease; display: flex !important; align-items: center; } [data-ui-component="TextInputAreaWrapper"]:focus-within { border-color: var(--gst-border-focus) !important; background-color: var(--gst-bg-2) !important; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3), 0 0 0 3px rgba(216, 184, 132, 0.25); } [data-ui-component="MessageInputTextarea"] { color: var(--gst-text-main) !important; caret-color: var(--gst-accent-gold); background: transparent !important; padding: 11px 8px !important; flex-grow: 1; font-size: inherit; line-height: 1.6 !important; } [data-ui-component="MessageInputTextarea"]::placeholder { color: var(--gst-text-sender) !important; opacity: 0.6; font-style: italic; } [data-ui-component="SendButtonContainer"] { background-color: var(--gst-accent-gold) !important; border-radius: 7px !important; margin-left: 10px !important; padding: 9px !important; transition: background-color 0.2s ease, transform 0.1s ease; box-shadow: 0 2px 4px var(--gst-shadow-medium); display: flex; align-items: center; justify-content: center; border: none; } [data-ui-component="SendButtonContainer"]:hover { background-color: var(--gst-accent-gold-hover) !important; transform: scale(1.05); } [data-ui-component="SendButtonIcon"] { stroke: var(--gst-bg-0) !important; width: 22px; height: 22px; }`
        },
        'ronin_red': {
            name: 'üèÆ Ronin Red',
            description: 'High-tech dark theme. Extreme contrast, sharp red accents, clear text hierarchy.',
            css: `:root { --rr-bg-0: #0A0A0C; --rr-bg-1: #121317; --rr-bg-2: #1C1E22; --rr-bg-3: #282A30; --rr-text-main: #F8F9FA; --rr-text-italic: #FF87A7; --rr-text-quote: #87CEFA; --rr-text-sender: #9098A8; --rr-accent-red: #F03E3E; --rr-accent-red-hover: #FF5C5C; --rr-accent-red-active: #D93434; --rr-border: #34363B; --rr-border-focus: #F03E3E; --rr-shadow-heavy: rgba(0, 0, 0, 0.6); --rr-shadow-medium: rgba(0, 0, 0, 0.4); --rr-shadow-light: rgba(0, 0, 0, 0.25); --rr-red-glow: 0 0 10px rgba(240, 62, 62, 0.5); --rr-user-message-bg: var(--rr-bg-1); --rr-bot-message-bg: var(--rr-bg-2); } html.dark body { background: var(--rr-bg-0) !important; font-family: 'Inter', sans-serif; } html.dark body::before { display: none !important; } [data-ui-component="SideNavBar"], ${SHARED_CHAT_CONTAINER_SELECTOR} { background-color: transparent !important; scrollbar-width: thin !important; scrollbar-color: var(--rr-bg-3) transparent !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar { width: 8px !important; height: 8px !important; background-color: transparent !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar-track, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar-track { background: rgba(18, 19, 23, 0.5) !important; border-radius: 4px !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar-thumb, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar-thumb { background-color: var(--rr-bg-3) !important; border-radius: 4px !important; border: 1px solid var(--rr-bg-1) !important; } [data-ui-component="SideNavBar"]::-webkit-scrollbar-thumb:hover, ${SHARED_CHAT_CONTAINER_SELECTOR}::-webkit-scrollbar-thumb:hover { background-color: var(--rr-accent-red-active) !important; } [data-ui-component="ChatHeaderBar"] { background: var(--rr-bg-1) !important; border-bottom: 1px solid var(--rr-border) !important; box-shadow: 0 3px 8px var(--rr-shadow-medium); padding: 6px 0 !important; } [data-ui-component="SideNavBar"] { background: var(--rr-bg-1) !important; border-right: 1px solid var(--rr-border) !important; box-shadow: 2px 0 7px var(--rr-shadow-medium); } [data-ui-component="ChatHeaderCharacterName"], [data-ui-component="ChatHeaderCreatorName"] { color: #D8DCE0 !important; font-weight: 500; } [data-ui-component="ChatHeaderShareButton"] svg, [data-ui-component="ChatHeaderMoreOptionsButton"] svg, [data-ui-component="ChatHeaderLikeButton"] svg { stroke: var(--rr-text-sender) !important; transition: stroke 0.2s ease, filter 0.2s ease; } [data-ui-component="ChatHeaderShareButton"]:hover svg, [data-ui-component="ChatHeaderMoreOptionsButton"]:hover svg, [data-ui-component="ChatHeaderLikeButton"]:hover svg { stroke: var(--rr-accent-red-hover) !important; filter: drop-shadow(var(--rr-red-glow)); } [data-ui-component^="SideNav"] button { color: var(--rr-text-sender) !important; transition: background-color 0.15s ease, color 0.15s ease, border-left-color 0.15s ease; border-radius: 0 4px 4px 0 !important; padding: 8px 12px 8px 15px; border-left: 3px solid transparent; } [data-ui-component^="SideNav"] button:hover { background-color: var(--rr-accent-red) !important; color: #FFFFFF !important; border-left-color: var(--rr-accent-red-hover); } [data-ui-component^="SideNav"] button svg { stroke: var(--rr-text-sender) !important; transition: stroke 0.15s ease; } [data-ui-component^="SideNav"] button:hover svg { stroke: #FFFFFF !important; } [data-ui-component="BotMessageContainer"], [data-ui-component="ChatHeroInnerContainer"] { background-color: color-mix(in srgb, transparent, var(--rr-bot-message-bg) calc(var(--message-bg-opacity) * 100%)) !important; } [data-ui-component="UserMessageBackgroundContainer"], [data-ui-component="ChatMessageWrapper"].bg-gray-4 { background-color: color-mix(in srgb, transparent, var(--rr-user-message-bg) calc(var(--message-bg-opacity) * 100%)) !important; } [data-ui-component="BotMessageContainer"], [data-ui-component="UserMessageBackgroundContainer"], [data-ui-component="ChatHeroInnerContainer"] { border: 1px solid var(--rr-border) !important; border-radius: 4px !important; padding: 1rem 1.3rem !important; margin-bottom: 1rem !important; box-shadow: 0 2px 5px var(--rr-shadow-light); transition: box-shadow 0.2s ease, border-color 0.2s ease, transform 0.1s ease, width 0.1s ease-out, background-color 0.2s ease; } [data-ui-component="BotMessageContainer"]:hover, [data-ui-component="UserMessageBackgroundContainer"]:hover { border-color: var(--rr-border-focus) !important; box-shadow: 0 4px 8px var(--rr-shadow-medium); transform: translateY(-1px); } [data-ui-component="BotMessageContainer"] { border-left: 3px solid var(--rr-accent-red) !important; } [data-ui-component="UserMessageBackgroundContainer"] { border-left: 3px solid var(--rr-bg-3) !important; } [data-ui-component="ChatHeroInnerContainer"] { background: var(--rr-bg-2) !important; border: 1px solid var(--rr-border) !important; box-shadow: 0 3px 8px var(--rr-shadow-medium); } [data-ui-component="MessageSenderName"] { color: var(--rr-text-sender) !important; font-weight: 600; margin-bottom: 5px; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; } [data-ui-component="MessageTextSpan"] { color: var(--rr-text-main) !important; line-height: inherit !important; } [data-ui-component="MessageTextSpan"] > em { color: var(--rr-text-italic) !important; font-style: italic !important; font-weight: 500; } [data-ui-component="MessageTextSpan"] > q { color: var(--rr-text-quote) !important; font-style: italic !important; opacity: 1; background-color: rgba(135, 206, 250, 0.1); border-left: 3px solid rgba(135, 206, 250, 0.5); padding: 0.1em 0.6em; display: inline-block; margin: 0.15em 0; border-radius: 0 4px 4px 0; } [data-ui-component="MessageActionsContainer"] button svg { stroke: var(--rr-text-sender) !important; transition: stroke 0.2s ease, filter 0.2s ease; } [data-ui-component="MessageActionsContainer"] button:hover svg { stroke: var(--rr-accent-red-hover) !important; filter: drop-shadow(var(--rr-red-glow)); } [data-ui-component="BotMessageRateButton"][aria-label*='Star-button'].opacity-100 svg { fill: var(--rr-accent-red) !important; stroke: var(--rr-accent-red) !important; filter: drop-shadow(var(--rr-red-glow)); } [data-ui-component="ChatInputBarContainer"] { background-color: transparent !important; border-top: none !important; padding: 5px 10px 15px 10px !important; } [data-ui-component="ChatInputBarInnerContainer"] { padding: 0 !important; } [data-ui-component="TextInputAreaWrapper"] { background-color: var(--rr-bg-1) !important; border: 1px solid var(--rr-border) !important; border-radius: 4px !important; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); margin: 0 !important; padding: 4px 10px !important; transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease; display: flex !important; align-items: center; } [data-ui-component="TextInputAreaWrapper"]:focus-within { border-color: var(--rr-border-focus) !important; background-color: var(--rr-bg-2) !important; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3), 0 0 0 3px rgba(240, 62, 62, 0.25); } [data-ui-component="MessageInputTextarea"] { color: var(--rr-text-main) !important; caret-color: var(--rr-accent-red); background: transparent !important; padding: 11px 8px !important; flex-grow: 1; font-size: inherit; line-height: 1.6 !important; } [data-ui-component="MessageInputTextarea"]::placeholder { color: var(--rr-text-sender) !important; opacity: 0.5; font-style: italic; } [data-ui-component="SendButtonContainer"] { background-color: var(--rr-accent-red) !important; border-radius: 4px !important; margin-left: 10px !important; padding: 9px !important; transition: background-color 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease; box-shadow: 0 2px 5px var(--rr-shadow-medium), var(--rr-red-glow); display: flex; align-items: center; justify-content: center; border: none; } [data-ui-component="SendButtonContainer"]:hover { background-color: var(--rr-accent-red-hover) !important; box-shadow: 0 3px 7px var(--rr-shadow-heavy), 0 0 12px rgba(255, 92, 92, 0.7); transform: scale(1.05); } [data-ui-component="SendButtonIcon"] { stroke: #FFFFFF !important; width: 22px; height: 22px; }`
        }
    };

    let logoElement, popupElement, dynamicStyleElement, themeStyleElement, backgroundStyleElement, widthStyleElement, guiStyleElement,
        settingsView, themesView, fontSlider, fontValue, widthSlider, widthValue, themeDisplay,
        changeThemeBtn, resetBtn, themeListContainer, backBtn,
        backgroundUrlInput, applyBgBtn, resetBgBtn,
        opacitySlider, opacityValue,
        avatarSizeSlider, avatarSizeValue,
        buttonOrderSelectElement,
        jumperEnableCheckbox,
        tokenCounterEnableCheckbox;

    let currentThemeKey = DEFAULT_THEME_KEY;
    let currentFontSize = DEFAULT_FONT_SIZE;
    let currentWidth = DEFAULT_WIDTH_SLIDER;
    let customBackgroundUrl = DEFAULT_BACKGROUND_URL;
    let currentOpacity = DEFAULT_OPACITY;
    let currentAvatarSize = DEFAULT_AVATAR_SIZE;
    let currentButtonOrder = DEFAULT_BUTTON_ORDER;

    let isInitialized = false;
    let contentObserver = null;
    let customizerRootStyleElement = null;
    let clickOutsidePopupHandler = null;

    const popupHTML = `
        <div id="${VIEW_SETTINGS_ID}" style="display: block;">
            <div class="customizer-header">UI Customizer v${GM_info.script.version}</div>
            <div class="customizer-section"> <label for="${FONT_SLIDER_ID}">Message Font Size</label> <div class="slider-container"> <input type="range" id="${FONT_SLIDER_ID}" min="8" max="32" step="1"> <span id="${FONT_VALUE_ID}"></span> </div> </div>
            <div class="customizer-section"> <label for="${WIDTH_SLIDER_ID}">Message Width</label> <div class="slider-container"> <input type="range" id="${WIDTH_SLIDER_ID}" min="${MIN_WIDTH_SLIDER}" max="${MAX_WIDTH_SLIDER}" step="1"> <span id="${WIDTH_VALUE_ID}"></span> </div> </div>
            <div class="customizer-section"> <label for="${OPACITY_SLIDER_ID}">Message BG Opacity</label> <div class="slider-container"> <input type="range" id="${OPACITY_SLIDER_ID}" min="0" max="1" step="0.01"> <span id="${OPACITY_VALUE_ID}"></span> </div> </div>
            <div class="customizer-section"> <label for="${AVATAR_SIZE_SLIDER_ID}">Avatar Size</label> <div class="slider-container"> <input type="range" id="${AVATAR_SIZE_SLIDER_ID}" min="${MIN_AVATAR_SIZE}" max="${MAX_AVATAR_SIZE}" step="1"> <span id="${AVATAR_SIZE_VALUE_ID}"></span> </div> </div>
            <div class="customizer-section">
                <label for="${BUTTON_ORDER_SELECT_ID}">Message Actions Button Order</label>
                <div class="select-container">
                    <select id="${BUTTON_ORDER_SELECT_ID}">
                        <option value="default">ChatPage v2</option>
                        <option value="new">ChatPage v1</option>
                    </select>
                </div>
            </div>
            <div class="customizer-section">
                <label for="${JUMPER_ENABLE_CHECKBOX_ID}">Enable Variant Jumper</label>
                <div class="checkbox-container">
                    <input type="checkbox" id="${JUMPER_ENABLE_CHECKBOX_ID}" class="customizer-checkbox">
                    <span class="checkbox-label-text">(Show/Hide tool to jump to specific response variant)</span>
                </div>
            </div>
            <div class="customizer-section">
                <label for="${TOKEN_COUNTER_ENABLE_CHECKBOX_ID}">Enable Token Counter</label>
                <div class="checkbox-container">
                    <input type="checkbox" id="${TOKEN_COUNTER_ENABLE_CHECKBOX_ID}" class="customizer-checkbox">
                    <span class="checkbox-label-text">(Based on OpenAI tokenizer - not perfectly accurate)</span>
                </div>
            </div>
            <div class="customizer-section theme-section"> <span>Current Theme: <strong id="${THEME_DISPLAY_ID}"></strong></span> <button id="${CHANGE_THEME_BTN_ID}" class="customizer-button">Change Theme</button> </div>
            <div class="customizer-section background-section"> <label for="${BACKGROUND_URL_INPUT_ID}">Custom Background URL</label> <input type="text" id="${BACKGROUND_URL_INPUT_ID}" placeholder="Enter image URL..."> <div class="button-group"> <button id="${APPLY_BG_BTN_ID}" class="customizer-button apply-bg">Apply BG</button> <button id="${RESET_BG_BTN_ID}" class="customizer-button secondary reset-bg">Reset BG</button> </div> </div>
            <div class="customizer-footer"> <button id="${RESET_BTN_ID}" class="customizer-button secondary">Reset Font & Width</button> </div>
        </div>
        <div id="${VIEW_THEMES_ID}" style="display: none;"> <div class="customizer-header">Choose Theme</div> <div id="${THEME_LIST_ID}" class="theme-list"></div> <div class="customizer-footer"> <button id="${BACK_BTN_ID}" class="customizer-button secondary">Back</button> </div> </div>
    `;

    const guiStyles = `
        #${POPUP_ID} { display: none !important; position: fixed !important; z-index: 100005 !important; top: 15px !important; right: 15px !important; background-color: rgba(44, 48, 56, 0.92) !important; color: #d8dee9 !important; border: 1px solid rgba(216, 222, 233, 0.15) !important; border-radius: 8px !important; width: clamp(280px, 30vw, 380px) !important; max-height: calc(100vh - 30px) !important; overflow-y: auto !important; padding: 0px !important; font-size: 13px !important; font-family: 'Inter', sans-serif !important; box-shadow: 0 6px 25px rgba(0,0,0,0.5) !important; backdrop-filter: blur(7px) !important; transition: opacity 0.2s ease, transform 0.2s ease; opacity: 0; transform: translateY(10px) scale(0.98); }
        #${POPUP_ID}.visible { display: block !important; opacity: 1; transform: translateY(0) scale(1); }
        #${POPUP_ID} .customizer-header { font-size: 15px; font-weight: 600; text-align: center; margin: 0; padding: 12px 18px 10px 18px; border-bottom: 1px solid rgba(216, 222, 233, 0.1); background-color: rgba(59, 66, 82, 0.6); border-radius: 8px 8px 0 0; color: #eceff4; }
        #${POPUP_ID} .customizer-section { margin-bottom: 18px; padding: 0 18px; }
        #${POPUP_ID} #${VIEW_SETTINGS_ID} .customizer-section:first-of-type { margin-top: 22px !important; }
        #${POPUP_ID} label { display: block; margin-bottom: 6px; font-weight: 500; color: #d8dee9; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; }
        #${POPUP_ID} .slider-container { display: flex; align-items: center; gap: 12px; }
        #${POPUP_ID} input[type="range"] { flex-grow: 1; cursor: pointer; -webkit-appearance: none; appearance: none; height: 6px; background: #434c5e; border-radius: 3px; outline: none; transition: background-color 0.15s ease; margin: 0; padding: 0; }
        #${POPUP_ID} input[type="range"]:hover { background: #4c566a; }
        #${POPUP_ID} input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: #88c0d0; border-radius: 50%; cursor: pointer; border: 2px solid #3b4252; transition: background-color 0.15s ease, transform 0.1s ease; }
        #${POPUP_ID} input[type="range"]::-moz-range-thumb { width: 16px; height: 16px; background: #88c0d0; border-radius: 50%; cursor: pointer; border: 2px solid #3b4252; }
        #${POPUP_ID} span[id*="-value"] { min-width: 45px; text-align: right; font-family: monospace; font-size: 14px; font-weight: bold; color: #eceff4; background: rgba(59, 66, 82, 0.4); padding: 2px 5px; border-radius: 4px; user-select: none; }
        #${POPUP_ID} .theme-section { display: flex; flex-direction: column; align-items: flex-start; gap: 10px; padding-top: 15px; border-top: 1px solid rgba(216, 222, 233, 0.1); margin-top: 18px; }
        #${POPUP_ID} .theme-section span { color: #d8dee9; font-size: 12px; }
        #${POPUP_ID} .theme-section strong { color: #eceff4; font-weight: 600; }
        #${POPUP_ID} .customizer-button { background-color: #5e81ac; color: #eceff4; border: none; border-radius: 5px; padding: 8px 15px; font-size: 13px; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease; box-shadow: 0 1px 2px rgba(0,0,0,0.2); width: 100%; text-align: center; }
        #${POPUP_ID} .customizer-button:hover { background-color: #81a1c1; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        #${POPUP_ID} .customizer-button:active { transform: translateY(1px); }
        #${POPUP_ID} .customizer-button.secondary { background-color: #4c566a; color: #d8dee9; }
        #${POPUP_ID} .customizer-button.secondary:hover { background-color: #5e6a7e; }
        #${POPUP_ID} .customizer-footer { margin-top: 0; padding: 15px 18px; border-top: 1px solid rgba(216, 222, 233, 0.1); }
        #${POPUP_ID} #${THEME_LIST_ID} { max-height: 280px; overflow-y: auto; margin: 10px 0; padding: 0 18px 10px 18px; }
        #${POPUP_ID} .theme-item { padding: 10px 12px; margin-bottom: 8px; border-radius: 6px; cursor: pointer; border: 1px solid rgba(76, 86, 106, 0.5); background-color: rgba(59, 66, 82, 0.4); transition: background-color 0.2s ease, border-color 0.2s ease; }
        #${POPUP_ID} .theme-item:hover { background-color: rgba(76, 86, 106, 0.7); border-color: #5e81ac; }
        #${POPUP_ID} .theme-item-name { font-weight: 600; display: block; margin-bottom: 4px; color: #eceff4; font-size: 14px; }
        #${POPUP_ID} .theme-item-desc { font-size: 12px; color: #d8dee9; opacity: 0.8; line-height: 1.4; }
        #${POPUP_ID} .background-section { padding-top: 15px; border-top: 1px solid rgba(216, 222, 233, 0.1); margin-top: 18px; }
        #${POPUP_ID} #${BACKGROUND_URL_INPUT_ID} { width: 100%; padding: 8px 10px; margin-top: 4px; margin-bottom: 10px; border: 1px solid #4c566a; background-color: rgba(59, 66, 82, 0.6); color: #eceff4; border-radius: 4px; font-size: 13px; box-sizing: border-box; }
        #${POPUP_ID} #${BACKGROUND_URL_INPUT_ID}::placeholder { color: #9098a8; opacity: 0.7; }
        #${POPUP_ID} .background-section .button-group { display: flex; gap: 10px; }
        #${POPUP_ID} .customizer-button.apply-bg { background-color: #8FBCBB; }
        #${POPUP_ID} .customizer-button.apply-bg:hover { background-color: #98C9C8; }
        #${LOGO_ID} { cursor: pointer !important; pointer-events: auto !important; transition: transform 0.2s ease, opacity 0.2s ease !important; opacity: 0.7 !important; }
        #${LOGO_ID}:hover { transform: scale(1.1) !important; opacity: 1 !important; }
        #${POPUP_ID} .select-container { display: flex; align-items: center; margin-top: 4px; }
        #${POPUP_ID} #${BUTTON_ORDER_SELECT_ID} { width: 100%; padding: 8px 10px; border: 1px solid #4c566a; background-color: rgba(59, 66, 82, 0.6); color: #eceff4; border-radius: 4px; font-size: 13px; box-sizing: border-box; cursor: pointer; font-family: 'Inter', sans-serif; }
        #${POPUP_ID} #${BUTTON_ORDER_SELECT_ID} option { background-color: #3B4252; color: #ECEFF4; }
        #${POPUP_ID} #${BUTTON_ORDER_SELECT_ID}:focus { outline: none; border-color: #88c0d0; box-shadow: 0 0 0 2px rgba(136, 192, 208, 0.3); }
        [data-ui-component="ChatInputBarContainer"] { padding-top: 3px !important; padding-bottom: 5px !important; position: absolute !important; bottom: 5px !important; left: 0 !important; right: 0 !important; max-width: 70% !important; margin-top: 0 !important; }
        ${SHARED_CHAT_CONTAINER_SELECTOR} { padding-bottom: 60px !important; }
        #${POPUP_ID} .checkbox-container { display: flex; align-items: center; margin-top: 4px; }
        #${POPUP_ID} .customizer-checkbox { margin-right: 8px; width: 16px; height: 16px; cursor: pointer; accent-color: #88c0d0; }
        #${POPUP_ID} .checkbox-label-text { font-size: 12px; color: #d8dee9; opacity: 0.7; }
        @media (max-width: 767px) {
            #${POPUP_ID} { width: auto !important; left: 10px !important; right: 10px !important; top: 10px !important; max-height: calc(100vh - 20px) !important; }
            #${POPUP_ID} .customizer-header, #${POPUP_ID} .customizer-section, #${POPUP_ID} #${VIEW_SETTINGS_ID} .customizer-section:first-of-type, #${POPUP_ID} .customizer-footer, #${POPUP_ID} #${THEME_LIST_ID} { padding-left: 12px !important; padding-right: 12px !important; }
            #${POPUP_ID} #${THEME_LIST_ID} { max-height: 240px; }
        }`;

    const TOKEN_COUNTER_CSS = `
        [data-ui-component*="ContentContainer"][${TOKEN_COUNTER_PROCESSED_MARKER}] {
            position: relative;
            padding-bottom: 25px !important;
        }

        [data-ui-component*="ContentContainer"][${TOKEN_COUNTER_PROCESSED_MARKER}]::after {
            content: "Tokens: " attr(${TOKEN_COUNTER_DATA_ATTRIBUTE_NAME});
            position: absolute;
            bottom: 5px;
            right: 5px;
            height: 20px;
            line-height: 20px;

            font-size: 0.75em;
            font-family: "SF Mono", "Consolas", "Menlo", "Courier New", monospace;
            color: #a8b2c7;
            user-select: none;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        [data-ui-component*="Container"]:hover [data-ui-component*="ContentContainer"][${TOKEN_COUNTER_PROCESSED_MARKER}]::after,
        [data-ui-component*="BackgroundContainer"]:hover [data-ui-component*="ContentContainer"][${TOKEN_COUNTER_PROCESSED_MARKER}]::after {
            opacity: 1;
        }

        [data-ui-component*="ContentContainer"][${TOKEN_COUNTER_DATA_ATTRIBUTE_NAME}="0 t"] {
            padding-bottom: 0 !important;
        }
        [data-ui-component*="ContentContainer"][${TOKEN_COUNTER_DATA_ATTRIBUTE_NAME}="0 t"]::after {
            display: none;
        }
    `;

    function styleAvatarImageTag(imgTag) { imgTag.style.width = '100%'; imgTag.style.height = '100%'; imgTag.style.objectFit = 'cover'; imgTag.style.display = 'block'; imgTag.style.borderRadius = '0'; }
    function processSingleAvatar(avatarButton, size) { if (!avatarButton) return; const sizePx = `${size}px`; avatarButton.style.width = sizePx; avatarButton.style.height = sizePx; avatarButton.style.borderRadius = '50%'; avatarButton.style.overflow = 'hidden'; avatarButton.style.display = 'inline-flex'; avatarButton.style.justifyContent = 'center'; avatarButton.style.alignItems = 'center'; avatarButton.style.border = 'none'; avatarButton.style.boxShadow = `0 0 0 1px rgba(0,0,0,0.2), inset 0 0 0 1px rgba(255,255,255,0.05)`; const img = avatarButton.querySelector('img'); if (img) { const classParamPattern = /\?class=avatar\d+x\d+/; let currentImgSrc = img.src; let newSrcCandidate = currentImgSrc; let needsSrcUpdate = false; if (currentImgSrc && currentImgSrc.match(classParamPattern)) { newSrcCandidate = currentImgSrc.replace(classParamPattern, ''); needsSrcUpdate = true; } if (needsSrcUpdate) { if (img.dataset.triedCleanSrc === newSrcCandidate && img.dataset.cleanSrcFailed === 'true') { styleAvatarImageTag(img); } else { const originalSrcForOnError = currentImgSrc; img.src = newSrcCandidate; img.dataset.triedCleanSrc = newSrcCandidate; img.dataset.cleanSrcFailed = 'false'; img.onerror = function() { if (img.src !== originalSrcForOnError) { img.src = originalSrcForOnError; } img.dataset.cleanSrcFailed = 'true'; img.onerror = null; img.onload = null; styleAvatarImageTag(img); }; img.onload = function() { img.dataset.cleanSrcFailed = 'false'; img.onload = null; img.onerror = null; styleAvatarImageTag(img); }; } } else { styleAvatarImageTag(img); } delete img.dataset.originalSrcAttempted; } avatarButton.dataset.processedBySize = String(size); }
    function applyCurrentAvatarSizeToAll(specificElements = null) { const elementsToProcess = specificElements || document.querySelectorAll(ALL_AVATAR_BUTTON_SELECTORS); const isCalledByObserver = !!specificElements; elementsToProcess.forEach(avatarButton => { if (!document.body.contains(avatarButton)) { return; } if (isCalledByObserver || avatarButton.dataset.processedBySize !== String(currentAvatarSize)) { processSingleAvatar(avatarButton, currentAvatarSize); } }); if (avatarSizeValue) avatarSizeValue.textContent = `${currentAvatarSize}px`; }
    function applyDynamicStyles() { if (!dynamicStyleElement) return; const fontSize = `${currentFontSize}px`; const lineHeight = `${Math.round(currentFontSize * 1.6)}px`; dynamicStyleElement.textContent = `:root { --dynamic-font-size: ${fontSize}; --dynamic-line-height: ${lineHeight}; } [data-ui-component="MessageTextSpan"], [data-ui-component="MessageTextSpan"] > em, [data-ui-component="MessageTextSpan"] > q { font-size: var(--dynamic-font-size) !important; } [data-ui-component="MessageContentContainer"] { line-height: var(--dynamic-line-height) !important; } [data-ui-component="MessageInputTextarea"] { font-size: var(--dynamic-font-size) !important; line-height: 1.5 !important; }`; if (fontValue) fontValue.textContent = `${currentFontSize}px`; }
    function applyWidthStyle(widthPercent) { if (!widthStyleElement) return; const customCSS = ` ${messageContainerSelector_SLIDER} { width: ${widthPercent}% !important; max-width: none !important; margin-left: auto !important; margin-right: auto !important; } `; widthStyleElement.textContent = customCSS; if (widthValue) widthValue.textContent = `${widthPercent}%`; }
    function applyOpacityStyle(opacity) { const opacityValueFormatted = parseFloat(opacity).toFixed(2); document.documentElement.style.setProperty('--message-bg-opacity', opacityValueFormatted); if (opacityValue) opacityValue.textContent = opacityValueFormatted; }
    function applyCustomBackground() { if (!backgroundStyleElement) return; if (customBackgroundUrl && customBackgroundUrl.trim() !== '') { try { const safeUrl = CSS.escape(customBackgroundUrl.trim()); backgroundStyleElement.textContent = `${BACKGROUND_TARGET_SELECTOR} { background-image: url("${safeUrl}") !important; background-size: cover !important; background-position: center center !important; background-repeat: no-repeat !important; background-attachment: fixed !important; }`; } catch (e) { console.error("Error applying custom background:", e); backgroundStyleElement.textContent = ''; } } else { backgroundStyleElement.textContent = ''; } }
    function applyTheme(themeKey) { currentThemeKey = themes[themeKey] ? themeKey : DEFAULT_THEME_KEY; const theme = themes[currentThemeKey]; if (!themeStyleElement) return; document.documentElement.className = document.documentElement.className.replace(/ theme-\S+/g, ''); document.documentElement.classList.add(`theme-${currentThemeKey}`); if(theme && theme.css && theme.css.trim() !== "") { themeStyleElement.textContent = theme.css; } else { themeStyleElement.textContent = ''; } if (themeDisplay && theme) themeDisplay.textContent = theme.name; if (popupElement) popupElement.dataset.activeTheme = currentThemeKey; document.documentElement.classList.add('dark'); document.documentElement.style.colorScheme = 'dark'; applyCustomBackground(); applyCurrentAvatarSizeToAll(); }

    async function saveFontSettings() { try { await GM_setValue(STORAGE_FONT_SIZE_KEY, currentFontSize); } catch (e) { console.error("Error saving font size:", e); } }
    async function saveWidthSettings() { try { await GM_setValue(STORAGE_WIDTH_KEY, currentWidth); } catch (e) { console.error("Error saving width:", e); } }
    async function saveThemePref() { try { await GM_setValue(STORAGE_THEME_KEY, currentThemeKey); } catch (e) { console.error("Error saving theme:", e); } }
    async function saveBackgroundUrl() { try { await GM_setValue(STORAGE_BACKGROUND_URL_KEY, customBackgroundUrl); } catch (e) { console.error("Error saving background URL:", e); } }
    async function saveOpacitySettings() { try { await GM_setValue(STORAGE_OPACITY_KEY, currentOpacity); } catch (e) { console.error("Error saving opacity:", e); } }
    async function saveAvatarSizeSettings() { try { await GM_setValue(STORAGE_AVATAR_SIZE_KEY, currentAvatarSize); } catch (e) { console.error("Error saving avatar size:", e); } }
    async function saveButtonOrder() { try { await GM_setValue(STORAGE_BUTTON_ORDER_KEY, currentButtonOrder); } catch (e) { console.error("Error saving button order:", e); } }
    async function saveJumperEnabledState() { try { await GM_setValue(STORAGE_JUMPER_ENABLED_KEY, isJumperEnabled); } catch (e) { console.error("Error saving Jumper state:", e); } }
    async function saveTokenCounterEnabledState() { try { await GM_setValue(STORAGE_TOKEN_COUNTER_ENABLED_KEY, isTokenCounterEnabled); } catch (e) { console.error("Error saving Token Counter state:", e); } }

    async function loadSettings() {  try { currentThemeKey = await GM_getValue(STORAGE_THEME_KEY, DEFAULT_THEME_KEY); currentFontSize = await GM_getValue(STORAGE_FONT_SIZE_KEY, DEFAULT_FONT_SIZE); currentWidth = await GM_getValue(STORAGE_WIDTH_KEY, DEFAULT_WIDTH_SLIDER); customBackgroundUrl = await GM_getValue(STORAGE_BACKGROUND_URL_KEY, DEFAULT_BACKGROUND_URL); currentOpacity = await GM_getValue(STORAGE_OPACITY_KEY, DEFAULT_OPACITY); currentAvatarSize = await GM_getValue(STORAGE_AVATAR_SIZE_KEY, DEFAULT_AVATAR_SIZE); currentButtonOrder = await GM_getValue(STORAGE_BUTTON_ORDER_KEY, DEFAULT_BUTTON_ORDER); isJumperEnabled = await GM_getValue(STORAGE_JUMPER_ENABLED_KEY, DEFAULT_JUMPER_ENABLED); isTokenCounterEnabled = await GM_getValue(STORAGE_TOKEN_COUNTER_ENABLED_KEY, DEFAULT_TOKEN_COUNTER_ENABLED); currentFontSize = Math.max(8, Math.min(32, parseInt(currentFontSize, 10) || DEFAULT_FONT_SIZE)); currentWidth = Math.max(MIN_WIDTH_SLIDER, Math.min(MAX_WIDTH_SLIDER, parseInt(currentWidth, 10) || DEFAULT_WIDTH_SLIDER)); currentOpacity = Math.max(0, Math.min(1, parseFloat(currentOpacity) || DEFAULT_OPACITY)); currentAvatarSize = Math.max(MIN_AVATAR_SIZE, Math.min(MAX_AVATAR_SIZE, parseInt(currentAvatarSize, 10) || DEFAULT_AVATAR_SIZE)); if (!themes[currentThemeKey]) { currentThemeKey = DEFAULT_THEME_KEY; await saveThemePref(); } } catch (e) { console.error("Error loading settings, reverting to defaults:", e); currentThemeKey = DEFAULT_THEME_KEY; currentFontSize = DEFAULT_FONT_SIZE; currentWidth = DEFAULT_WIDTH_SLIDER; customBackgroundUrl = DEFAULT_BACKGROUND_URL; currentOpacity = DEFAULT_OPACITY; currentAvatarSize = DEFAULT_AVATAR_SIZE; currentButtonOrder = DEFAULT_BUTTON_ORDER; isJumperEnabled = DEFAULT_JUMPER_ENABLED; isTokenCounterEnabled = DEFAULT_TOKEN_COUNTER_ENABLED; } }
    function resetFontAndWidthSettings() { currentFontSize = DEFAULT_FONT_SIZE; currentWidth = DEFAULT_WIDTH_SLIDER; if (fontSlider) fontSlider.value = currentFontSize; if (widthSlider) widthSlider.value = currentWidth; applyDynamicStyles(); applyWidthStyle(currentWidth); saveFontSettings(); saveWidthSettings(); }
    function resetBackground() { customBackgroundUrl = null; if (backgroundUrlInput) backgroundUrlInput.value = ''; saveBackgroundUrl(); applyCustomBackground(); }
    function populateThemeList() { if (!themeListContainer) return; themeListContainer.innerHTML = ''; for (const key in themes) { const theme = themes[key]; const item = document.createElement('div'); item.className = 'theme-item'; item.dataset.themeKey = key; item.innerHTML = `<span class="theme-item-name">${theme.name}</span> <span class="theme-item-desc">${theme.description}</span>`; item.addEventListener('click', () => { applyTheme(key); saveThemePref(); switchView('settings'); }); themeListContainer.appendChild(item); } }
    function switchView(viewName) { if (!settingsView || !themesView || !popupElement) return; settingsView.style.display = (viewName === 'settings') ? 'block' : 'none'; themesView.style.display = (viewName === 'themes') ? 'block' : 'none'; }
    function positionPopup() { if (!popupElement) return; popupElement.style.top = '15px'; popupElement.style.right = '15px'; popupElement.style.bottom = 'auto'; popupElement.style.left = 'auto'; }
    function togglePopup() { if (!popupElement) { return; } const isVisible = popupElement.classList.contains('visible'); if (!isVisible) { positionPopup(); void popupElement.offsetWidth; popupElement.classList.add('visible'); } else { popupElement.classList.remove('visible'); } }
    function reorderButtonsInContainer(actionsContainer) {  if (!actionsContainer || !document.body.contains(actionsContainer)) { return; } const buttonParent = actionsContainer.querySelector('div.flex.justify-between.items-center > div.flex.items-center.gap-2'); if (!buttonParent) { return; } const computedStyle = window.getComputedStyle(buttonParent); const isActive = parseFloat(computedStyle.opacity) > 0.5 && computedStyle.display !== 'none'; if (!isActive && buttonParent.dataset.scButtonOrderApplied) { return; } if (!isActive && !buttonParent.dataset.scButtonOrderApplied){ return; } if (buttonParent.dataset.scButtonOrderApplied === currentButtonOrder && isActive) { return; } const buttons = { star: buttonParent.querySelector(BUTTON_SELECTOR_STAR), tts: buttonParent.querySelector(BUTTON_SELECTOR_TTS), regenerate: buttonParent.querySelector(BUTTON_SELECTOR_REGENERATE), edit: buttonParent.querySelector(BUTTON_SELECTOR_EDIT) }; Object.values(buttons).forEach(btn => { if (btn && btn.parentElement === buttonParent) { buttonParent.removeChild(btn); } }); let orderToAppend = []; if (currentButtonOrder === 'new') { orderToAppend = [buttons.star, buttons.tts, buttons.regenerate, buttons.edit]; } else { orderToAppend = [buttons.regenerate, buttons.edit, buttons.star, buttons.tts]; } orderToAppend.forEach(button => { if (button) { buttonParent.appendChild(button); } }); buttonParent.dataset.scButtonOrderApplied = currentButtonOrder; }
    function applyButtonOrderToAllMessageActions(checkVisibility = false) {  document.querySelectorAll(MESSAGE_ACTIONS_CONTAINER_SELECTOR).forEach(container => { if (checkVisibility) { const buttonParent = container.querySelector('div.flex.justify-between.items-center > div.flex.items-center.gap-2'); if (buttonParent) { const computedStyle = window.getComputedStyle(buttonParent); const isActive = parseFloat(computedStyle.opacity) > 0.5 && computedStyle.display !== 'none'; if (!isActive) { return; } } else { return; } } reorderButtonsInContainer(container); }); }
    function observeContent() {  const targetNode = document.querySelector(CHAT_MESSAGES_CONTAINER_SELECTOR); if (!targetNode) { return false; } const config = { childList: true, subtree: true, attributes: true, attributeFilter: ['style', 'class'] }; const callback = function(mutationsList, observer) { const addedAvatarButtons = new Set(); const affectedMessageActionContainers = new Set(); for (const mutation of mutationsList) { if (mutation.type === 'childList') { for (const node of mutation.addedNodes) { if (node.nodeType === Node.ELEMENT_NODE) { if (node.matches && node.matches(ALL_AVATAR_BUTTON_SELECTORS)) { addedAvatarButtons.add(node); } node.querySelectorAll(ALL_AVATAR_BUTTON_SELECTORS).forEach(avatar => addedAvatarButtons.add(avatar)); if (node.matches && node.matches(MESSAGE_ACTIONS_CONTAINER_SELECTOR)) { if (node.querySelector('div.flex.justify-between.items-center > div.flex.items-center.gap-2')) { affectedMessageActionContainers.add(node); } } node.querySelectorAll(MESSAGE_ACTIONS_CONTAINER_SELECTOR).forEach(container => { if (container.querySelector('div.flex.justify-between.items-center > div.flex.items-center.gap-2')) { affectedMessageActionContainers.add(container); } }); } } } else if (mutation.type === 'attributes') { const targetElement = mutation.target; const mainActionsContainer = targetElement.closest(MESSAGE_ACTIONS_CONTAINER_SELECTOR); if (mainActionsContainer) { const buttonParent = mainActionsContainer.querySelector('div.flex.justify-between.items-center > div.flex.items-center.gap-2'); if (buttonParent && (targetElement === buttonParent || targetElement === mainActionsContainer || buttonParent.contains(targetElement))) { if (document.body.contains(mainActionsContainer)) { affectedMessageActionContainers.add(mainActionsContainer); } } } } if (mutation.target && mutation.target.nodeType === Node.ELEMENT_NODE) { const parentContainer = mutation.target.closest(MESSAGE_ACTIONS_CONTAINER_SELECTOR); if (parentContainer) { if (document.body.contains(parentContainer) && parentContainer.querySelector('div.flex.justify-between.items-center > div.flex.items-center.gap-2')) { affectedMessageActionContainers.add(parentContainer); } } } } if (addedAvatarButtons.size > 0) { applyCurrentAvatarSizeToAll(Array.from(addedAvatarButtons)); } if (affectedMessageActionContainers.size > 0) { affectedMessageActionContainers.forEach(container => reorderButtonsInContainer(container)); } }; if (contentObserver) { contentObserver.disconnect(); } contentObserver = new MutationObserver(callback); contentObserver.observe(targetNode, config); return true; }

    function jumper_jumpToVariant(targetVariantNumber) {  const outerMessageContainers = document.querySelectorAll(JUMPER_OUTER_MESSAGE_CONTAINER_SELECTOR); if (outerMessageContainers.length === 0) { console.error("[LLM Jumper] No bot message containers found."); alert("No bot messages with variants detected. Make sure a bot has replied."); return; } const outerMessageContainer = outerMessageContainers[outerMessageContainers.length - 1]; if (!outerMessageContainer) { console.error("[LLM Jumper] Last bot message container not found."); alert("Last bot message container not found. Ensure an LLM message with variants is visible."); return; } const nextButton = outerMessageContainer.querySelector(JUMPER_NEXT_BUTTON_SELECTOR); const prevButton = outerMessageContainer.querySelector(JUMPER_PREV_BUTTON_SELECTOR); const currentVariantTextElement = outerMessageContainer.querySelector(JUMPER_CURRENT_VARIANT_TEXT_SELECTOR); if (!nextButton || !prevButton || !currentVariantTextElement) { console.error("[LLM Jumper] Next/Prev buttons or variant text element not found."); alert("Could not find navigation buttons or variant count. The site structure might have changed or this message has no variants."); return; } const currentText = currentVariantTextElement.textContent.trim(); const match = currentText.match(/(\d+)\s*\/\s*(\d+)/); if (!match) { console.error("[LLM Jumper] Could not parse current variant text. Text: " + currentText); alert("Could not understand the current variant format (e.g., '1/3'). Text found: " + currentText); return; } const currentIndex = parseInt(match[1], 10) - 1; const totalVariants = parseInt(match[2], 10); const targetIndex = targetVariantNumber - 1; if (targetIndex < 0 || targetIndex >= totalVariants) { alert(`Variant ${targetVariantNumber} is out of range. Available: 1 to ${totalVariants}.`); return; } let steps = 0; if (targetIndex > currentIndex) { steps = targetIndex - currentIndex; for (let i = 0; i < steps; i++) { setTimeout(() => nextButton.click(), i * 100); } } else if (targetIndex < currentIndex) { steps = currentIndex - targetIndex; for (let i = 0; i < steps; i++) { setTimeout(() => prevButton.click(), i * 100); } } }

    function jumper_dragStart(clientX, clientY) {
        if (!jumperUiContainer) return;
        jumperIsDragging = true;
        const rect = jumperUiContainer.getBoundingClientRect();
        jumperOffsetX = clientX - rect.left;
        jumperOffsetY = clientY - rect.top;

        if (!jumperUiContainer.style.left || !jumperUiContainer.style.top) {
            jumperUiContainer.style.left = `${rect.left}px`;
            jumperUiContainer.style.top = `${rect.top}px`;
            jumperUiContainer.style.right = '';
            jumperUiContainer.style.bottom = '';
        }
        document.addEventListener('mousemove', jumper_onMouseMove);
        document.addEventListener('mouseup', jumper_onMouseUp);
        document.addEventListener('touchmove', jumper_onTouchMove, { passive: false });
        document.addEventListener('touchend', jumper_onTouchEnd);
    }

    function jumper_dragMove(clientX, clientY) {
        if (!jumperIsDragging || !jumperUiContainer) return;
        let newX = clientX - jumperOffsetX;
        let newY = clientY - jumperOffsetY;

        newX = Math.max(0, Math.min(newX, window.innerWidth - jumperUiContainer.offsetWidth));
        newY = Math.max(0, Math.min(newY, window.innerHeight - jumperUiContainer.offsetHeight));

        jumperUiContainer.style.left = `${newX}px`;
        jumperUiContainer.style.top = `${newY}px`;
    }

    async function jumper_dragEnd() {
        if (!jumperIsDragging || !jumperUiContainer) return;
        jumperIsDragging = false;
        document.removeEventListener('mousemove', jumper_onMouseMove);
        document.removeEventListener('mouseup', jumper_onMouseUp);
        document.removeEventListener('touchmove', jumper_onTouchMove);
        document.removeEventListener('touchend', jumper_onTouchEnd);

        try {
            await GM_setValue(STORAGE_JUMPER_UI_POS_KEY, {
                left: jumperUiContainer.style.left,
                top: jumperUiContainer.style.top
            });
        } catch (err) {
            console.error("Error saving Jumper UI position:", err);
        }
    }

    function jumper_onMouseDown(e) {
        if (e.button !== 0) return;
        jumper_dragStart(e.clientX, e.clientY);
    }
    function jumper_onMouseMove(e) {
        e.preventDefault();
        jumper_dragMove(e.clientX, e.clientY);
    }
    async function jumper_onMouseUp() {
        await jumper_dragEnd();
    }

    function jumper_onTouchStart(e) {
        if (e.touches.length !== 1) return;
        e.preventDefault();
        jumper_dragStart(e.touches[0].clientX, e.touches[0].clientY);
    }
    function jumper_onTouchMove(e) {
        if (e.touches.length !== 1) return;
        e.preventDefault();
        jumper_dragMove(e.touches[0].clientX, e.touches[0].clientY);
    }
    async function jumper_onTouchEnd() {
        await jumper_dragEnd();
    }


    async function initializeJumper() {
        if (document.getElementById(JUMPER_UI_CONTAINER_ID)) {
            jumperUiContainer = document.getElementById(JUMPER_UI_CONTAINER_ID);
            jumperUiContainer.style.display = 'block';
            return;
        }
        jumperUiContainer = document.createElement('div');
        jumperUiContainer.id = JUMPER_UI_CONTAINER_ID;
        jumperUiContainer.style.position = 'fixed';
        jumperUiContainer.style.background = 'rgba(30,30,30,0.9)';
        jumperUiContainer.style.color = '#e0e0e0';
        jumperUiContainer.style.padding = '12px';
        jumperUiContainer.style.borderRadius = '6px';
        jumperUiContainer.style.zIndex = '99999';
        jumperUiContainer.style.cursor = 'move';
        jumperUiContainer.style.userSelect = 'none';
        jumperUiContainer.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
        jumperUiContainer.style.display = 'block';
        jumperUiContainer.setAttribute('touch-action', 'none');

        let savedPosition;
        try { savedPosition = await GM_getValue(STORAGE_JUMPER_UI_POS_KEY); }
        catch (err) { console.error("Error loading Jumper UI position:", err); savedPosition = null; }

        if (savedPosition && typeof savedPosition.left !== 'undefined' && typeof savedPosition.top !== 'undefined') {
            jumperUiContainer.style.left = savedPosition.left;
            jumperUiContainer.style.top = savedPosition.top;
        } else {
            jumperUiContainer.style.right = '20px';
            jumperUiContainer.style.bottom = '20px';
        }
        jumperUiContainer.innerHTML = `
            <div id="${JUMPER_UI_HEADER_ID}" style="padding-bottom: 8px; border-bottom: 1px solid #555; margin-bottom: 10px; text-align: center; cursor: move;">
                <span style="font-weight: bold; font-size: 1.1em;">Variant Jumper</span>
            </div>
            <label for="${JUMPER_INPUT_ID}" style="margin-right: 8px; font-size: 0.95em;">Jump to:</label>
            <input type="number" id="${JUMPER_INPUT_ID}" style="width: 55px; padding: 6px; border: 1px solid #777; border-radius: 4px; background-color: #f0f0f0; color: #333; user-select: text; font-size: 1.15em; font-weight: bold;">
            <button id="${JUMPER_BUTTON_ID}" style="margin-left: 8px; padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.95em;">Jump</button>
        `;
        document.body.appendChild(jumperUiContainer);

        const input = document.getElementById(JUMPER_INPUT_ID);
        const button = document.getElementById(JUMPER_BUTTON_ID);
        const header = document.getElementById(JUMPER_UI_HEADER_ID);

        function performJumpAction() {  const variantNum = parseInt(input.value, 10); if (!isNaN(variantNum) && variantNum > 0) { jumper_jumpToVariant(variantNum); input.value = ''; } else { alert('Please enter a valid positive number for the variant (e.g., 1, 5, 99).'); input.focus(); } }
        button.addEventListener('click', performJumpAction);
        input.addEventListener('keydown', (event) => { if (event.key === 'Enter') { event.preventDefault(); performJumpAction(); } });
        input.addEventListener('mousedown', (e) => e.stopPropagation());
        input.addEventListener('touchstart', (e) => e.stopPropagation());
        button.addEventListener('mousedown', (e) => e.stopPropagation());
        button.addEventListener('touchstart', (e) => e.stopPropagation());

        const draggableElement = header || jumperUiContainer;
        draggableElement.addEventListener('mousedown', jumper_onMouseDown);
        draggableElement.addEventListener('touchstart', jumper_onTouchStart, { passive: false });
    }

    function teardownJumper() {
        const draggableElement = document.getElementById(JUMPER_UI_HEADER_ID) || (jumperUiContainer ? jumperUiContainer : document.getElementById(JUMPER_UI_CONTAINER_ID));
        if (draggableElement) {
            draggableElement.removeEventListener('mousedown', jumper_onMouseDown);
            draggableElement.removeEventListener('touchstart', jumper_onTouchStart);
        }
        document.removeEventListener('mousemove', jumper_onMouseMove);
        document.removeEventListener('mouseup', jumper_onMouseUp);
        document.removeEventListener('touchmove', jumper_onTouchMove);
        document.removeEventListener('touchend', jumper_onTouchEnd);

        if (jumperUiContainer) {
            jumperUiContainer.remove();
            jumperUiContainer = null;
        }
        jumperIsDragging = false;
    }

    function tokenCounter_ensureStyleElement() { if (!tokenCounter_styleElement) { tokenCounter_styleElement = document.createElement('style'); tokenCounter_styleElement.id = TOKEN_COUNTER_STYLE_ID; document.head.appendChild(tokenCounter_styleElement); } }
    function tokenCounter_applyStyles() { tokenCounter_ensureStyleElement(); tokenCounter_styleElement.textContent = TOKEN_COUNTER_CSS; }
    function tokenCounter_removeStyles() { if (tokenCounter_styleElement) { tokenCounter_styleElement.textContent = ''; } }
    function tokenCounter_removeProcessedMarkers() { document.querySelectorAll(`[${TOKEN_COUNTER_PROCESSED_MARKER}]`).forEach(el => { el.removeAttribute(TOKEN_COUNTER_PROCESSED_MARKER); el.removeAttribute(TOKEN_COUNTER_DATA_ATTRIBUTE_NAME); }); }
    async function tokenCounter_loadTokenizer() { if (tokenCounter_tokenizerModuleLoaded && typeof tokenCounter_countTokensFunc === 'function') { return true; } try { const m = await import('https://spicychat.ai/assets/gpt-token-Ba_r2oKT.js'); const { e: encode } = m; if (typeof encode !== 'function') { console.error('SpicyChat Token Counter: –§—É–Ω–∫—Ü–∏—è encode –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –º–æ–¥—É–ª–µ.'); return false; } tokenCounter_countTokensFunc = text => { if (!text || typeof text !== 'string' || text.trim() === '') return 0; try { const encoded = encode(text); return encoded?.tokens?.length || 0; } catch (err) { console.error('SpicyChat Token Counter: –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞:', text, err); return 0; } }; tokenCounter_tokenizerModuleLoaded = true; return true; } catch (err) { console.error('SpicyChat Token Counter: –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä–∞.', err); tokenCounter_tokenizerModuleLoaded = false; tokenCounter_countTokensFunc = null; return false; } }
    function tokenCounter_processMessageElement(messageEl) { if (!tokenCounter_countTokensFunc) return; if (messageEl.hasAttribute(TOKEN_COUNTER_PROCESSED_MARKER) && messageEl.hasAttribute(TOKEN_COUNTER_DATA_ATTRIBUTE_NAME)) { return; } let currentParent = messageEl.parentElement; let depth = 0; const maxDepth = 5; while (currentParent && depth < maxDepth) { if (currentParent.hasAttribute(TOKEN_COUNTER_PROCESSED_MARKER) && currentParent.hasAttribute(TOKEN_COUNTER_DATA_ATTRIBUTE_NAME)) { return; } if (currentParent.matches('body') || currentParent === document.documentElement) break; currentParent = currentParent.parentElement; depth++; } const textContent = (messageEl.textContent || "").trim(); if (textContent === '') { messageEl.setAttribute(TOKEN_COUNTER_PROCESSED_MARKER, 'empty'); messageEl.setAttribute(TOKEN_COUNTER_DATA_ATTRIBUTE_NAME, "0 t"); return; } const tokenCount = tokenCounter_countTokensFunc(textContent); messageEl.setAttribute(TOKEN_COUNTER_DATA_ATTRIBUTE_NAME, `${tokenCount} t`); messageEl.setAttribute(TOKEN_COUNTER_PROCESSED_MARKER, 'true'); }
    function tokenCounter_processAllExistingMessages() { if (!tokenCounter_countTokensFunc || !isTokenCounterEnabled) return; document.querySelectorAll(`${TOKEN_COUNTER_BOT_MESSAGE_SELECTOR}:not([${TOKEN_COUNTER_PROCESSED_MARKER}]), ${TOKEN_COUNTER_BOT_MESSAGE_SELECTOR}:not([${TOKEN_COUNTER_DATA_ATTRIBUTE_NAME}])`).forEach(tokenCounter_processMessageElement); document.querySelectorAll(`${TOKEN_COUNTER_USER_MESSAGE_SELECTOR}:not([${TOKEN_COUNTER_PROCESSED_MARKER}]), ${TOKEN_COUNTER_USER_MESSAGE_SELECTOR}:not([${TOKEN_COUNTER_DATA_ATTRIBUTE_NAME}])`).forEach(tokenCounter_processMessageElement); }
    function tokenCounter_observeNewMessages() { if (!tokenCounter_countTokensFunc || !isTokenCounterEnabled) return; if (tokenCounter_observer) tokenCounter_observer.disconnect(); const chatArea = document.querySelector(CHAT_MESSAGES_CONTAINER_SELECTOR); if (!chatArea) { console.error('SpicyChat Token Counter: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞ –¥–ª—è MutationObserver.'); return; } tokenCounter_observer = new MutationObserver(mutations => { if (!isTokenCounterEnabled) return; let needsProcessing = false; for (const mutation of mutations) { if (mutation.type === 'childList' && mutation.addedNodes.length > 0) { mutation.addedNodes.forEach(node => { if (node.nodeType === Node.ELEMENT_NODE) { if (node.matches(TOKEN_COUNTER_BOT_MESSAGE_SELECTOR) || node.matches(TOKEN_COUNTER_USER_MESSAGE_SELECTOR) || node.querySelector(TOKEN_COUNTER_BOT_MESSAGE_SELECTOR) || node.querySelector(TOKEN_COUNTER_USER_MESSAGE_SELECTOR)) { needsProcessing = true; } } }); } if (mutation.type === 'characterData' && mutation.target.parentElement) { const parentEl = mutation.target.parentElement.closest(TOKEN_COUNTER_USER_MESSAGE_SELECTOR + ',' + TOKEN_COUNTER_BOT_MESSAGE_SELECTOR); if (parentEl && parentEl.hasAttribute(TOKEN_COUNTER_PROCESSED_MARKER)) { parentEl.removeAttribute(TOKEN_COUNTER_PROCESSED_MARKER); parentEl.removeAttribute(TOKEN_COUNTER_DATA_ATTRIBUTE_NAME); needsProcessing = true; } } } if(needsProcessing){ setTimeout(tokenCounter_processAllExistingMessages, 150); } }); tokenCounter_observer.observe(chatArea, { childList: true, subtree: true, characterData: true }); }
    async function activateTokenCounter() { if (!isTokenCounterEnabled || !window.location.pathname.startsWith('/chat/')) return; tokenCounter_applyStyles(); const tokenizerLoaded = await tokenCounter_loadTokenizer(); if (tokenizerLoaded) { if (tokenCounter_initializationTimer) clearTimeout(tokenCounter_initializationTimer); tokenCounter_initializationTimer = setTimeout(() => { if (!isTokenCounterEnabled) return; tokenCounter_processAllExistingMessages(); tokenCounter_observeNewMessages(); }, 1000); } else { console.warn("Token Counter: Tokenizer module failed to load. Counter will not function."); } }
    function deactivateTokenCounter() { if (tokenCounter_initializationTimer) { clearTimeout(tokenCounter_initializationTimer); tokenCounter_initializationTimer = null; } if (tokenCounter_observer) { tokenCounter_observer.disconnect(); tokenCounter_observer = null; } tokenCounter_removeStyles(); tokenCounter_removeProcessedMarkers(); }

    const eventHandlers = { togglePopup: (e) => { e.stopPropagation(); togglePopup(); }, fontSliderInput: () => { currentFontSize = fontSlider.value; applyDynamicStyles(); }, widthSliderInput: () => { currentWidth = widthSlider.value; applyWidthStyle(currentWidth); }, opacitySliderInput: () => { currentOpacity = opacitySlider.value; applyOpacityStyle(currentOpacity); }, avatarSizeSliderInput: () => { currentAvatarSize = avatarSizeSlider.value; applyCurrentAvatarSizeToAll(); }, buttonOrderSelectChange: () => { currentButtonOrder = buttonOrderSelectElement.value; saveButtonOrder(); document.querySelectorAll(MESSAGE_ACTIONS_CONTAINER_SELECTOR).forEach(container => { const buttonParent = container.querySelector('div.flex.justify-between.items-center > div.flex.items-center.gap-2'); if (buttonParent) { delete buttonParent.dataset.scButtonOrderApplied; } }); applyButtonOrderToAllMessageActions(true); }, jumperCheckboxChange: () => { isJumperEnabled = jumperEnableCheckbox.checked; saveJumperEnabledState(); if (isJumperEnabled) { if (window.location.pathname.startsWith('/chat/')) { initializeJumper(); } } else { teardownJumper(); } }, tokenCounterCheckboxChange: async () => { isTokenCounterEnabled = tokenCounterEnableCheckbox.checked; await saveTokenCounterEnabledState(); if (isTokenCounterEnabled) { if (window.location.pathname.startsWith('/chat/')) { activateTokenCounter(); } } else { deactivateTokenCounter(); } }, resetBtnClick: resetFontAndWidthSettings, changeThemeBtnClick: () => switchView('themes'), backBtnClick: () => switchView('settings'), applyBgBtnClick: () => { const url = backgroundUrlInput.value.trim(); customBackgroundUrl = url; saveBackgroundUrl(); applyCustomBackground(); }, resetBgBtnClick: resetBackground };
    function addElementEventListeners() { fontSlider.addEventListener('input', eventHandlers.fontSliderInput); fontSlider.addEventListener('change', saveFontSettings); widthSlider.addEventListener('input', eventHandlers.widthSliderInput); widthSlider.addEventListener('change', saveWidthSettings); opacitySlider.addEventListener('input', eventHandlers.opacitySliderInput); opacitySlider.addEventListener('change', saveOpacitySettings); avatarSizeSlider.addEventListener('input', eventHandlers.avatarSizeSliderInput); avatarSizeSlider.addEventListener('change', saveAvatarSizeSettings); buttonOrderSelectElement.addEventListener('change', eventHandlers.buttonOrderSelectChange); jumperEnableCheckbox.addEventListener('change', eventHandlers.jumperCheckboxChange); tokenCounterEnableCheckbox.addEventListener('change', eventHandlers.tokenCounterCheckboxChange); resetBtn.addEventListener('click', eventHandlers.resetBtnClick); changeThemeBtn.addEventListener('click', eventHandlers.changeThemeBtnClick); backBtn.addEventListener('click', eventHandlers.backBtnClick); applyBgBtn.addEventListener('click', eventHandlers.applyBgBtnClick); resetBgBtn.addEventListener('click', eventHandlers.resetBgBtnClick); }
    function removeElementEventListeners() { if (!fontSlider) return; fontSlider.removeEventListener('input', eventHandlers.fontSliderInput); fontSlider.removeEventListener('change', saveFontSettings); widthSlider.removeEventListener('input', eventHandlers.widthSliderInput); widthSlider.removeEventListener('change', saveWidthSettings); opacitySlider.removeEventListener('input', eventHandlers.opacitySliderInput); opacitySlider.removeEventListener('change', saveOpacitySettings); avatarSizeSlider.removeEventListener('input', eventHandlers.avatarSizeSliderInput); avatarSizeSlider.removeEventListener('change', saveAvatarSizeSettings); buttonOrderSelectElement.removeEventListener('change', eventHandlers.buttonOrderSelectChange); if (jumperEnableCheckbox) jumperEnableCheckbox.removeEventListener('change', eventHandlers.jumperCheckboxChange); if (tokenCounterEnableCheckbox) tokenCounterEnableCheckbox.removeEventListener('change', eventHandlers.tokenCounterCheckboxChange); resetBtn.removeEventListener('click', eventHandlers.resetBtnClick); changeThemeBtn.removeEventListener('click', eventHandlers.changeThemeBtnClick); backBtn.removeEventListener('click', eventHandlers.backBtnClick); applyBgBtn.removeEventListener('click', eventHandlers.applyBgBtnClick); resetBgBtn.removeEventListener('click', eventHandlers.resetBgBtnClick); }
    async function initialize() { logoElement = document.getElementById(LOGO_ID); if (!logoElement) { return; } if (isInitialized) { return; } isInitialized = true; try { if (!customizerRootStyleElement) { customizerRootStyleElement = document.createElement('style'); document.head.appendChild(customizerRootStyleElement); customizerRootStyleElement.textContent = ':root { --message-bg-opacity: 1.0; }'; } if (!dynamicStyleElement) { dynamicStyleElement = document.createElement('style'); dynamicStyleElement.id = DYNAMIC_STYLE_ID; document.head.appendChild(dynamicStyleElement); } if (!themeStyleElement) { themeStyleElement = document.createElement('style'); themeStyleElement.id = THEME_STYLE_ID; document.head.appendChild(themeStyleElement); } if (!backgroundStyleElement) { backgroundStyleElement = document.createElement('style'); backgroundStyleElement.id = BACKGROUND_STYLE_ID; document.head.appendChild(backgroundStyleElement); } if (!widthStyleElement) { widthStyleElement = document.createElement('style'); widthStyleElement.id = WIDTH_STYLE_ID; document.head.appendChild(widthStyleElement); } if (!guiStyleElement) { guiStyleElement = document.createElement('style'); guiStyleElement.id = GUI_STYLES_ID; document.head.appendChild(guiStyleElement); guiStyleElement.textContent = guiStyles; } tokenCounter_ensureStyleElement(); await loadSettings(); if (!document.getElementById(POPUP_ID)) { popupElement = document.createElement('div'); popupElement.id = POPUP_ID; document.body.appendChild(popupElement); } else { popupElement = document.getElementById(POPUP_ID); } popupElement.innerHTML = popupHTML; settingsView = document.getElementById(VIEW_SETTINGS_ID); themesView = document.getElementById(VIEW_THEMES_ID); fontSlider = document.getElementById(FONT_SLIDER_ID); fontValue = document.getElementById(FONT_VALUE_ID); widthSlider = document.getElementById(WIDTH_SLIDER_ID); widthValue = document.getElementById(WIDTH_VALUE_ID); opacitySlider = document.getElementById(OPACITY_SLIDER_ID); opacityValue = document.getElementById(OPACITY_VALUE_ID); avatarSizeSlider = document.getElementById(AVATAR_SIZE_SLIDER_ID); avatarSizeValue = document.getElementById(AVATAR_SIZE_VALUE_ID); buttonOrderSelectElement = document.getElementById(BUTTON_ORDER_SELECT_ID); jumperEnableCheckbox = document.getElementById(JUMPER_ENABLE_CHECKBOX_ID); tokenCounterEnableCheckbox = document.getElementById(TOKEN_COUNTER_ENABLE_CHECKBOX_ID); themeDisplay = document.getElementById(THEME_DISPLAY_ID); changeThemeBtn = document.getElementById(CHANGE_THEME_BTN_ID); resetBtn = document.getElementById(RESET_BTN_ID); themeListContainer = document.getElementById(THEME_LIST_ID); backBtn = document.getElementById(BACK_BTN_ID); backgroundUrlInput = document.getElementById(BACKGROUND_URL_INPUT_ID); applyBgBtn = document.getElementById(APPLY_BG_BTN_ID); resetBgBtn = document.getElementById(RESET_BG_BTN_ID); if (!settingsView || !themesView || !fontSlider || !jumperEnableCheckbox || !tokenCounterEnableCheckbox) { isInitialized = false; return; } populateThemeList(); fontSlider.value = currentFontSize; widthSlider.value = currentWidth; opacitySlider.value = currentOpacity; avatarSizeSlider.value = currentAvatarSize; buttonOrderSelectElement.value = currentButtonOrder; jumperEnableCheckbox.checked = isJumperEnabled; tokenCounterEnableCheckbox.checked = isTokenCounterEnabled; backgroundUrlInput.value = customBackgroundUrl || ''; applyTheme(currentThemeKey); applyDynamicStyles(); applyWidthStyle(currentWidth); applyOpacityStyle(currentOpacity); applyButtonOrderToAllMessageActions(); const isOnChatPage = window.location.pathname.startsWith('/chat/'); if (isJumperEnabled && isOnChatPage) { initializeJumper(); } if (isTokenCounterEnabled && isOnChatPage) { activateTokenCounter(); } if (!logoElement.dataset.customizerListener) { logoElement.addEventListener('click', eventHandlers.togglePopup); logoElement.dataset.customizerListener = 'true'; } addElementEventListeners(); clickOutsidePopupHandler = (event) => { if (popupElement && popupElement.classList.contains('visible')) { if (!popupElement.contains(event.target) && (!logoElement || !logoElement.contains(event.target))) { const jumperUI = document.getElementById(JUMPER_UI_CONTAINER_ID); if (!jumperUI || !jumperUI.contains(event.target)) { togglePopup(); } } } }; document.removeEventListener('click', clickOutsidePopupHandler, true); document.addEventListener('click', clickOutsidePopupHandler, true); if (isOnChatPage) observeContent(); } catch (error) { console.error("Fatal error during UI Customizer initialization:", error); teardownCustomizer(); } }
    function teardownCustomizer() { if (!isInitialized && !popupElement && !customizerRootStyleElement) return; if (isJumperEnabled) { teardownJumper(); } if (isTokenCounterEnabled) { deactivateTokenCounter(); } if (popupElement) { popupElement.remove(); popupElement = null; } if (customizerRootStyleElement) { customizerRootStyleElement.remove(); customizerRootStyleElement = null; } if (dynamicStyleElement) { dynamicStyleElement.remove(); dynamicStyleElement = null; } if (themeStyleElement) { themeStyleElement.remove(); themeStyleElement = null; } if (backgroundStyleElement) { backgroundStyleElement.remove(); backgroundStyleElement = null; } if (widthStyleElement) { widthStyleElement.remove(); widthStyleElement = null; } if (guiStyleElement) { guiStyleElement.remove(); guiStyleElement = null; } if (tokenCounter_styleElement) { tokenCounter_styleElement.remove(); tokenCounter_styleElement = null; } if (contentObserver) { contentObserver.disconnect(); contentObserver = null; } if (logoElement && logoElement.dataset.customizerListener) { logoElement.removeEventListener('click', eventHandlers.togglePopup); delete logoElement.dataset.customizerListener; } if (clickOutsidePopupHandler) { document.removeEventListener('click', clickOutsidePopupHandler, true); clickOutsidePopupHandler = null; } removeElementEventListeners(); settingsView = themesView = fontSlider = fontValue = widthSlider = widthValue = opacitySlider = opacityValue = avatarSizeSlider = avatarSizeValue = buttonOrderSelectElement = jumperEnableCheckbox = tokenCounterEnableCheckbox = themeDisplay = changeThemeBtn = resetBtn = themeListContainer = backBtn = backgroundUrlInput = applyBgBtn = resetBgBtn = null; isInitialized = false; }
    function handleNavigation() { const isOnChatPage = window.location.pathname.startsWith('/chat/'); if (isOnChatPage) { if (isInitialized) { if (!document.getElementById(LOGO_ID) || !document.querySelector(CHAT_MESSAGES_CONTAINER_SELECTOR)) { teardownCustomizer(); } else { if (!contentObserver || !document.querySelector(CHAT_MESSAGES_CONTAINER_SELECTOR)?.contains(contentObserver?.target )) { if (!observeContent() && contentObserver) { } } applyButtonOrderToAllMessageActions(true); applyCurrentAvatarSizeToAll(); if (isJumperEnabled && !document.getElementById(JUMPER_UI_CONTAINER_ID)) { initializeJumper(); } else if (!isJumperEnabled && document.getElementById(JUMPER_UI_CONTAINER_ID)) { teardownJumper(); } if (isTokenCounterEnabled && (!tokenCounter_countTokensFunc || !tokenCounter_observer)) { activateTokenCounter(); } else if (!isTokenCounterEnabled && (tokenCounter_countTokensFunc || tokenCounter_observer)) { deactivateTokenCounter(); } } } } else { if (isInitialized) { teardownCustomizer(); } } }
    document.addEventListener('LogicCoreReady', (event) => { const isOnChatPage = window.location.pathname.startsWith('/chat/'); if (isOnChatPage) { if (isInitialized && document.getElementById(POPUP_ID)) { applyButtonOrderToAllMessageActions(true); applyCurrentAvatarSizeToAll(); if (isJumperEnabled && !document.getElementById(JUMPER_UI_CONTAINER_ID)) { initializeJumper(); } if (isTokenCounterEnabled) { activateTokenCounter(); } if(!observeContent() && contentObserver) { teardownCustomizer(); } } else { initialize(); } } else { if(isInitialized) teardownCustomizer(); } });
    window.addEventListener('customPushstate_SLC', handleNavigation);
    window.addEventListener('customReplacestate_SLC', handleNavigation);
    window.addEventListener('popstate', handleNavigation);
    function initialLoadCheck() { if (document.readyState === 'complete' || document.readyState === 'interactive') { if (!isInitialized && document.getElementById(LOGO_ID)) { handleNavigation(); } else if (!isInitialized && !document.getElementById(LOGO_ID) && window.location.pathname.startsWith('/chat/')) { let attempts = 0; const logoWaitInterval = setInterval(() => { attempts++; if (document.getElementById(LOGO_ID)) { clearInterval(logoWaitInterval); handleNavigation(); } else if (attempts > 50) { clearInterval(logoWaitInterval); console.warn("UI Customizer: Timed out waiting for LogicCore logo for initial load."); } }, 100); } else if (isInitialized && !window.location.pathname.startsWith('/chat/')) { handleNavigation(); } } }
    if (document.readyState === 'complete' || document.readyState === 'interactive') { setTimeout(initialLoadCheck, 200); } else { document.addEventListener('DOMContentLoaded', () => setTimeout(initialLoadCheck, 200), { once: true }); }

})();
